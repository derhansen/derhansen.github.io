---
layout: post
title: Faster builds of my TYPO3 extensions on Travis CI
date: '2015-06-29T10:42:00.001+02:00'
author: Torben Hansen
tags:
- travis ci
- extension
- TYPO3
- build
- container based build
modified_time: '2015-06-29T10:44:44.029+02:00'
blogger_id: tag:blogger.com,1999:blog-6517038209122183182.post-9050159300648008165
blogger_orig_url: http://www.derhansen.de/2015/06/faster-builds-of-my-typo3-extensions-on-travisci.html
permalink: /2015/06/faster-builds-of-my-typo3-extensions-on-travisci.html
---

<b>tl;dr </b>If your Travis CI project was created before 01.01.2015 and you think your builds must run faster, switch to container based builds by adding <i>sudo: false</i>&nbsp;and configuring a cache for composer dependencies in your .travis.yml file.<br /><br />Nearly all my Open Source TYPO3 extensions are built on Travis CI. This runs really fine and I am very happy with the service Travis CI offers for free if your project is Open Source. What I did'nt know was, that Travic CI also offers the possibility to use container based builds (saw it first in this&nbsp;<a href="https://github.com/TYPO3/TYPO3.CMS/commit/c758e6dd3c408e3b01bdc1efe94607f670a14271" target="_blank">commit</a>&nbsp;for the&nbsp;<b>TYPO3 master)</b>.&nbsp;This feature was <a href="http://blog.travis-ci.com/2014-12-17-faster-builds-with-container-based-infrastructure/" target="_blank">announced</a> in the end of 2014 and has some advantages over the Travis CI standard infrastructure. Container based builds do have <b>more resources</b> (2 cores vs. 1.5 cores and 4 GB Ram vs. 3 GB ram), <b>better network capacity</b> and can use a <b>cache</b> for dependencies (e.g. composer dependencies).<br /><br />My extension <b>sf_event_mgt</b> has a lot of functional tests and since I also collect code coverage data, builds did run very long (15-30 minutes, worst result was more than 48 minutes) on the Travis CI standard infrastructure. Since my Travis CI project was created before the <b>1st of january 2015</b>, my builds were automatically built using the old infrastructure. I therefore tried to use the container based infrastructure to see if my builds would run faster.<br /><br />In order to force your build to run on the container based infrastructure, you just have to add the following to your .travis.yml file.<br /><pre><code><br />sudo: false<br /><br />cache:<br />  directories:<br />    - $HOME/.composer/cache<br /></code></pre><br />The <i>sudo: false</i> option tells Travis CI to use the container based infrastructure and the cache configuration sets the <b>cache-directory</b>, which will <b>persist during builds</b>.<br /><br />When I started the first build, I was really amazed about how fast the builds started and how much faster builds were completed. There was only one problem, which showed up in the logs.<br /><pre><code><br />  - Installing  symfony/yaml  ( v2.7.1 )<br />    Downloading:  connection...      Failed to download symfony/yaml from dist: Could not authenticate against github.com <br />    Now trying to download from source <br />  - Installing symfony/yaml  ( v2.7.1 )<br />    Cloning 9808e75c609a14f6db02f70fccf4ca4aab53c160<br /></code></pre><br />In order to fix the failing download of dependencies from github.com, you must create an OAUTH token for your GitHub repository and add it to the .travis.yml. I therefore created an OAUTH token (which just has read access to my public repositoried) in my GitHub account. Next I added the OATH token to the .travis.yml file. As the token should and must be kept secret, Travis CI offers the possibility to <a href="http://docs.travis-ci.com/user/encryption-keys/" target="_blank">encrypt sensitive data</a>. For my TYPO3 extension sf_event_mgt I did as shown below:<br /><pre><code><br />sudo gem install travis<br />travis encrypt GITHUB_COMPOSER_AUTH=my-github-oauth-token -r derhansen/sf_event_mgt<br /></code></pre><br />Next I added the resulting encrypted key to my .travis.yml and configured composer to use the GitHub OAUTH token if available.<br /><br /><pre><code><br />env:<br />  global:<br />    secure: my-encrypted-key<br /><br />before_script:<br />  - if [ "$GITHUB_COMPOSER_AUTH" ]; then composer config -g github-oauth.github.com $GITHUB_COMPOSER_AUTH; fi<br />  - composer install<br /></code></pre><br />After restarting the build, the error did'nt show up in the logs of my Travis CI build any more. My complete configuration can be found in this <a href="https://gist.github.com/derhansen/016c9e35647bef7bf486" target="_blank">gist</a>.<br /><br />Finally, the switch to the container based builds seems to have <b>reduced the average build time</b> by <b>about 50% </b>and seems to run <b>more stable</b> than before.<br /><br /><br />