---
layout: post
title: FlexForms Optionen in Abhängigkeit von switchableControllerActions
date: '2012-07-05T09:05:00.000+02:00'
author: Torben Hansen
tags:
- FlexForms
- Extbase
- TYPO3
- switchablecontrolleractions
modified_time: '2013-10-18T07:28:00.283+02:00'
blogger_id: tag:blogger.com,1999:blog-6517038209122183182.post-4126798877471238403
blogger_orig_url: http://www.derhansen.de/2012/07/flexforms-optionen-in-abhangigkeit-von.html
permalink: /2012/07/flexforms-optionen-in-abhangigkeit-von.html
---

Es gibt im Netz eine Vielzahl guter Tutorials wie man in einer TYPO3 Extbase Extension die Plugin-Optionen per Flexform konfigurierbar macht. Nun kann es aber vorkommen, dass man für bestimmte Konfigurations-Einstellungen unterschiedliche Einstellungsmöglichkeiten anzeigen möchte. Hierfür muss das Flexform so konfiguriert werden, dass bestimmte Einstellungsmöglichkeiten nur in Abhängigkeit von anderen Einstellungen möglich sind. Wie man dieses genau realisiert, zeige ich in diesem Artikel.<br /><br />Als technische Grundlage für den Artikel dient die Extension "news" von Georg Ringer. Dort habe ich zum ersten mal bewusst diese Technik gesehen.<br /><br />Als erstes erstellt man eine XML-Datei für die Flexform-Konfiguration. Als Beispiel dient die Datei&nbsp;<b>/Configuration/FlexForms/flexform.xml</b><br /><br /><pre><code class="xml"><br />&lt;T3DataStructure&gt;<br /> &lt;langDisable&gt;1&lt;/langdisable&gt;<br /> &lt;sheets&gt;<br />  &lt;sDEF&gt;<br />   &lt;ROOT&gt;<br />    &lt;TCEforms&gt;<br />     &lt;sheetTitle&gt;Settings&lt;/sheetTitle&gt;<br />    &lt;/TCEforms&gt;<br />    &lt;type&gt;array&lt;/type&gt;<br />    &lt;el&gt;<br />     <br />     &lt;switchableControllerActions&gt;<br />      &lt;TCEforms&gt;<br />      &lt;label&gt;Mode&lt;/label&gt;<br />      &lt;onChange&gt;reload&lt;/onChange&gt;<br />      &lt;config&gt;<br />       &lt;type&gt;select&lt;/type&gt;<br />       &lt;items type="array"&gt;<br />        &lt;numIndex index="1" type="array"&gt;<br />         &lt;numIndex index="0"&gt;List-Mode&lt;/numIndex&gt;<br />         &lt;numIndex index="1"&gt;Testcontroller-&gt;list&lt;/numIndex&gt;<br />        &lt;/numIndex&gt;<br />        &lt;numIndex index="2" type="array"&gt;<br />         &lt;numIndex index="0"&gt;Single-Mode&lt;/numIndex&gt;<br />         &lt;numIndex index="1"&gt;Testcontroller-&gt;details&lt;/numIndex&gt;<br />        &lt;/numIndex&gt;<br />       &lt;/items&gt;<br />      &lt;/config&gt;<br />      &lt;/TCEforms&gt;<br />     &lt;/switchableControllerActions&gt;<br /><br />     <br />     &lt;settings.showrandom&gt;<br />      &lt;TCEforms&gt;<br />       &lt;label&gt;Random&lt;/label&gt;<br />       &lt;config&gt;<br />        &lt;type&gt;check&lt;/type&gt;<br />       &lt;/config&gt;<br />      &lt;/TCEforms&gt;<br />     &lt;/settings.record&gt;<br /><br />     <br />     &lt;settings.record&gt;<br />      &lt;TCEforms&gt;<br />       &lt;label&gt;Record&lt;/label&gt;<br />       &lt;config&gt;<br />        &lt;type&gt;group&lt;/type&gt;<br />        &lt;internal_type&gt;db&lt;/internal_type&gt;<br />        &lt;allowed&gt;tx_extbasetest_domain_model_test&lt;/allowed&gt;<br />        &lt;size&gt;1&lt;/size&gt;<br />        &lt;maxitems&gt;1&lt;/maxitems&gt;<br />        &lt;minitems&gt;0&lt;/minitems&gt;<br />        &lt;show_thumbs&gt;1&lt;/show_thumbs&gt;<br />       &lt;/config&gt;<br />      &lt;/TCEforms&gt;<br />     &lt;/settings.record&gt;<br /><br />    &lt;/el&gt;<br />   &lt;/ROOT&gt;<br />  &lt;/sDEF&gt;<br /> &lt;/sheets&gt;<br />&lt;/T3DataStructure&gt;<br /></code></pre><br />Wichtig sind die beiden settings-Knoten, welche später Abhängig vom ausgewählten Modus (hier der Knoten switchablecontrolleractions) angezeigt bzw. ausgeblendet werden.<br /><br />Als nächstes wird das FlexForm.xml in die Extension eingebunden, sodass die Einstellungsmöglichkeiten im Plugin zur Verfügung stehen. Dafür wird in der <b>ext_tables.php</b> folgende Zeile hinzugefügt.<br /><br /><pre><code><br />$pluginSignature = str_replace('_','',$_EXTKEY) . '_' . extbasetest;<br />$TCA['tt_content']['types']['list']['subtypes_addlist'][$pluginSignature] = 'pi_flexform';<br />t3lib_extMgm::addPiFlexFormValue($pluginSignature, 'FILE:EXT:' . $_EXTKEY . '/Configuration/FlexForms/flexform.xml');<br /><br /></code></pre>Die FlexForm Konfiguration ist somit eigentlich schon fertig und man hat nun in den Plugin-Einstellungen zum einen eine ComboBox, wo man einstellen kann, ob man eine Listen- oder eine Detailansicht anzeigen möchte und zum anderen werden jeweils noch eine Checkbox und ein TYPO3 Datensatz Selektor angezeigt. Die letzten beiden Optionen sollen nun aber nur angezeigt werden, wenn wir in der ComboBox den Listenmodus aktiviert haben. Um dieses zu realisieren, bedienen wir uns des Hooks <b>getFlexFormDSClass</b>, welcher von&nbsp;<b>t3lib/class.t3lib_befunc.php</b> zur Verfügung gestellt wird.<br /><br />In der <b>ext_localconf.php</b> muss dazu folgende Zeile hinzugefügt werden.<br /><br /><pre><code><br />$GLOBALS['TYPO3_CONF_VARS']['SC_OPTIONS']['t3lib/class.t3lib_befunc.php']['getFlexFormDSClass'][$_EXTKEY] =<br /> 'EXT:' . $_EXTKEY. '/Classes/Hooks/T3libBefunc.php:Tx_Extbasetest_Hooks_T3libBefunc';<br /></code></pre><br />Der Hook sorgt dafür, dass wir die Datenstruktur der Flexform zur Laufzeit verändern können. Wie aus der ext_localconf.php hervorgeht, wird der Hook über die Klasse <b>Tx_Extbasetest_Hooks_T3libBefunc</b> angesprochen. Diese muss nun angelegt werden.<br /><pre><code><br />class Tx_Extbasetest_Hooks_T3libBefunc {<br /><br /> /**<br />  * Fields which are removed in details view<br />  *<br />  * @var array<br />  */<br /> public $removedFieldsInDetailsView = array(<br />   'sDEF' =&gt; 'record,showrandom'<br />  );<br /><br /> /**<br />  * Hook function of t3lib_befunc<br />  * It is used to change the flexform if it is about news<br />  *<br />  * @param array &amp;$dataStructure Flexform structure<br />  * @param array $conf some strange configuration<br />  * @param array $row row of current record<br />  * @param string $table table anme<br />  * @param string $fieldName some strange field name<br />  * @return void<br />  */<br /> public function getFlexFormDS_postProcessDS(&amp;$dataStructure, $conf, $row, $table, $fieldName) {<br />  //t3lib_div::debug($row);<br />  if ($table === 'tt_content' &amp;&amp; $row['list_type'] === 'extbasetest_extbasetest' &amp;&amp; is_array($dataStructure)) {<br />   $this-&gt;updateFlexforms($dataStructure, $row);<br />  }<br /> }<br /><br /> /**<br />  * Update flexform configuration if a action is selected<br />  *<br />  * @param array|string &amp;$dataStructure flexform structur<br />  * @param array $row row of current record<br />  * @return void<br />  */<br /> protected function updateFlexforms(array &amp;$dataStructure, array $row) {<br />  $selectedView = '';<br /><br />   // get the first selected action<br />  $flexformSelection = t3lib_div::xml2array($row['pi_flexform']);<br />  if (is_array($flexformSelection) &amp;&amp; is_array($flexformSelection['data'])) {<br />   $selectedView = $flexformSelection['data']['sDEF']['lDEF']['switchableControllerActions']['vDEF'];<br />   if (!empty($selectedView)) {<br />    $actionParts = t3lib_div::trimExplode(';', $selectedView, TRUE);<br />    $selectedView = $actionParts[0];<br />   }<br /><br />   // new plugin element<br />  } elseif(t3lib_div::isFirstPartOfStr($row['uid'], 'NEW')) {<br />    // use List as starting view<br />    // @todo dynamic check, getting view from $flexformSelection<br />   $selectedView = 'Extbasetest-&gt;list';<br />  }<br /><br />  if (!empty($selectedView)) {<br />    // modify the flexform structure depending on the first found action<br />   switch ($selectedView) {<br />    case 'Extbasetest-&gt;list':<br />     break;<br />    case 'Extbasetest-&gt;details':<br />     $this-&gt;deleteFromStructure($dataStructure, $this-&gt;removedFieldsInDetailsView);<br />     break;<br />   }<br />  }<br /> }<br /><br /> /**<br />  * Remove fields from flexform structure<br />  *<br />  * @param array &amp;$dataStructure flexform structure<br />  * @param array $fieldsToBeRemoved fields which need to be removed<br />  * @return void<br />  */<br /> private function deleteFromStructure(array &amp;$dataStructure, array $fieldsToBeRemoved) {<br />  foreach ($fieldsToBeRemoved as $sheetName =&gt; $sheetFields) {<br />   $fieldsInSheet = t3lib_div::trimExplode(',', $sheetFields, TRUE);<br /><br />   foreach ($fieldsInSheet as $fieldName) {<br />    unset($dataStructure['sheets'][$sheetName]['ROOT']['el']['settings.' . $fieldName]);<br />   }<br />  }<br /> }<br />}<br /></code></pre><br />Die Klasse habe ich fast 1:1 von der "news" Extension übernommen und angepasst. Anbei nun eine kurze Erläuterung, worauf man zu achten hat.<br /><br /><ul><li>Im Array&nbsp;<b>$removedFieldsInDetailsView</b> wird festgelegt, welche Felder in der Detailansicht ausgeblendet werden sollen. Hier kann man auch mehrere Sheets angeben, falls das FlexForm über mehrere Sheets verfügt.</li><li>In der Methode&nbsp; <b>getFlexFormDS_postProcessDS</b> muss man darauf achten, dass man die Variable <b>$row['list_type']</b> auch mit dem Namen seines Plugins vergleicht.</li><li>In der Methode&nbsp;<b>updateFlexforms</b> muss man nun noch seine eigenen Controller ansprechen (in diesem Fall Extbasetest)</li><li>Aus der Methode&nbsp;<b>deleteFromStructure </b>geht hervor, dass die Settings im FlexForm.xml alls mit "<b>settings.</b>" beginnen müssen, damit das Ein- bzw. Ausblenden der Optionen per Hook funktioniert.</li></ul><br />Nachdem alle Einstellungen wie im Beispiel oben gezeigt vorgenommen wurden, müsste man in den Plugin-Optionen nun zwischen einer Listen- und einer Detail-Ansicht wechseln können und es müssten bei der Listenansicht die Zusatzoptionen angezeigt werden, welche in der Detailansicht nicht zur Verfügung stehen.<br /><br /><i><u>Update 18.10.2013</u></i><br /><i><br /></i>Das alles geht auch einfacher mit displayCond (Beispiel unten).<br /><pre><code><br />     &lt;settings.record&gt;<br />      &lt;TCEforms&gt;<br />       &lt;label&gt;Record&lt;/label&gt;<br />       &lt;displayCond&gt;FIELD:switchableControllerActions:=:Testcontroller-&gt;list&lt;/displayCond&gt;<br />       &lt;config&gt;<br />        &lt;type&gt;group&lt;/type&gt;<br />        &lt;internal_type&gt;db&lt;/internal_type&gt;<br />        &lt;allowed&gt;tx_extbasetest_domain_model_test&lt;/allowed&gt;<br />        &lt;size&gt;1&lt;/size&gt;<br />        &lt;maxitems&gt;1&lt;/maxitems&gt;<br />        &lt;minitems&gt;0&lt;/minitems&gt;<br />        &lt;show_thumbs&gt;1&lt;/show_thumbs&gt;<br />       &lt;/config&gt;<br />      &lt;/TCEforms&gt;<br />     &lt;/settings.record&gt;<br /></code></pre>