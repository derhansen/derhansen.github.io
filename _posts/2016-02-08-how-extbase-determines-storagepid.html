---
layout: post
title: How Extbase determines the storagePid setting for a plugin
date: '2016-02-08T08:00:00.000+01:00'
author: Torben Hansen
tags:
- TYPO3 7.6
- Extbase
- storagePid
- TYPO3 6.2
modified_time: '2016-04-17T19:06:53.787+02:00'
blogger_id: tag:blogger.com,1999:blog-6517038209122183182.post-849144282647254052
blogger_orig_url: http://www.derhansen.de/2016/02/how-extbase-determines-storagepid.html
permalink: /2016/02/how-extbase-determines-storagepid.html
---

When you search for the terms "extbase storagePid" in your favorite search engine, you will find several blogs, forum-posts, mailing list entries and code examples on how to set the storagePid for the plugin of an Extbase extension. &nbsp;Many examples refer to TypoScript persistence settings for the extension itself (<b>plugin.tx_myext.persistence.storagePid</b><b>)</b>, which is good, as long as you do not <i>directly</i> set persistence settings for a plugin like shown in the example.<br /><br /><h3>Example</h3><br />Let us assume, that you have a TYPO3 Extbase extension, that has configured a storagePid for a plugin in TypoScript as shown below.<br /><br /><pre><code><br />plugin.tx_myext_myplugin {<br /> persistence {<br />  storagePid = {$plugin.tx_myext_myplugin.persistence.storagePid}<br /> }<br />}<br /></code></pre>Now you want the editor to be able to set the storagePid from the plugin settings. Since a TYPO3 plugin by default has a configuration setting called <b>Record Storage Page, </b>you use this configuration setting and select a page.<br /><br />Surprisingly, the Plugin will still use the setting configured in TypoScript. But why?<br /><br /><h3>Extbase storagePid determination</h3><br />Extbase uses the configurationManager to determine the storagePid. When you create an Extbase extension which should be configurable by users, it is important to understand <b>how and in which order </b>Extbase <b>determines/overrides</b> the storagePid for a plugin.<br /><br /><h4>Step 1 - Default storagePid</h4><br />Extbase uses the default storagePid which is 0<br /><br /><h4>Step 2 - Extbase persistence settings</h4><br />If Extbase has configured a storagePid in&nbsp;<b>config.tx_extbase.persistence.storagePid</b>, then Extbase will use this storagePid. <i>(note, in the code, this happens before before step 1)</i><br /><div><br /></div><h4>Step 3 - Extension/Plugin configuration from TypoScript</h4><br />Extbase fetches the configuration for the <b>plugin</b> from TypoScript persistence settings in <b>plugin.tx_myext.persistence.storagePid </b><i>and</i>&nbsp;<i>merges it</i>&nbsp;<i>with</i><b>&nbsp;</b><b>plugin.tx_myext_myplugin.persistence.storagePid&nbsp;</b>- The plugin settings override the extension settings. If the resulting storagePid is set (or empty), Extbase will use the configured value as storagePid<br /><br /><h4>Step 4 - Override storagePid from starting point setting</h4><br />If the plugin uses the starting point (Record Storage Page) and one/multiple pages are selected as starting point, Extbase will now use this as storagePid.<br /><br /><h4>Step 5 - Override storagePid from Plugin settings</h4><br />Now Extbase fetches the configuration for the <b>plugin</b> from TypoScript from&nbsp;<b>plugin.tx_myext_myplugin.persistence.storagePid&nbsp;</b>and if set (or empty), Extbase now uses this as storagePid.<br /><h4><br />Step 6 - Override storagePid from Flexform</h4><br />Finally Extbase checks, if the plugin has configured a flexform and if so, it merges all <b>settings</b>, <b>persistence</b> and <b>view</b> elements from the flexform with the current Extbase plugin configuration. The merge is done recursive and settings from TypoScript will be overridden by the flexform settings. So if you have configured <b>persistence.storagePid</b> in your flexform, this will be used as the storagePid.<br /><br />Make sure you read the&nbsp;<b>important note</b>&nbsp;below, since there is something to keep in mind when working with empty flexform values.<br /><br /><h4>Step 7 - Expand storagePid if recursive setting is set</h4><br />If&nbsp;<b>persistence.recursive </b>is set in<b>&nbsp;</b><b>plugin.tx_myext_myplugin </b>or in your <b>flexform, </b>Extbase will expand all configured storagePids recursive by the configured depth. If set, the final storagePid will contain a list of page uids for all subfolders of the original storagePid.<br /><br /><br />It is important to know, that each determination step will <b>override</b> the storagePid setting from the previous step. So for our example from above, the starting point setting gets overridden by the Plugin TypoScript setting.<br /><br />Also keep in mind, that as soon as you use&nbsp;<b>plugin.tx_myext_myplugin.persistence.storagePid</b>, the persistence settings for the extension&nbsp;<b>plugin.tx_myext.persistence.storagePid </b>and also the<b> record storage page settings </b>will&nbsp;get<b> overridden.</b><br /><b><br /></b><br /><h3>StoragePid when creating new records</h3><br />When you have set the storagePid (which in fact may contain several page uids), Extbase will always use the <b>first uid</b> when creating a new record. So if you have configured &nbsp;<b>plugin.tx_myext_myplugin.persistence.storagePid = 10,11,12 </b>then new records created from the plugin will be saved to the page with the uid 10.<br /><br />In order to override this behaviour, you can either add a property to your domain object which contains the page uid - e.g. getPid() - or you can override the storagePid for new records by TypoScript with the newRecordStoragePid setting as shown below:<br /><pre><code><br />plugin.tx_myext {<br /> persistence {<br />  storagePid = {$plugin.tx_myext.persistence.storagePid}<br />  classes {<br />   Vendor\Myext\Domain\Model\Mymodel {<br />    newRecordStoragePid = 16<br />   }<br />  }<br /> }<br />}<br /></code></pre><br /><h3>Setting the storagePid from flexform</h3><br />To set the storagePid from flexform, you can use the code snippet below. It is an extract from a flexform XML structure which contains a field for the storagePid and another field for the recursive setting.<br /><pre><code><br />&lt;persistence.storagePid&gt;<br />    &lt;TCEforms&gt;<br />        &lt;exclude&gt;1&lt;/exclude&gt;<br />        &lt;label&gt;Storage PID&lt;/label&gt;<br />        &lt;config&gt;<br />            &lt;type&gt;group&lt;/type&gt;<br />            &lt;internal_type&gt;db&lt;/internal_type&gt;<br />            &lt;allowed&gt;pages&lt;/allowed&gt;<br />            &lt;size&gt;3&lt;/size&gt;<br />            &lt;maxitems&gt;99&lt;/maxitems&gt;<br />            &lt;minitems&gt;0&lt;/minitems&gt;<br />            &lt;show_thumbs&gt;1&lt;/show_thumbs&gt;<br />            &lt;wizards&gt;<br />                &lt;suggest&gt;<br />                    &lt;type&gt;suggest&lt;/type&gt;<br />                &lt;/suggest&gt;<br />            &lt;/wizards&gt;<br />        &lt;/config&gt;<br />    &lt;/TCEforms&gt;<br />&lt;/persistence.storagePid&gt;<br /><br />&lt;persistence.recursive&gt;<br />    &lt;TCEforms&gt;<br />        &lt;label&gt;LLL:EXT:lang/locallang_general.xlf:LGL.recursive&lt;/label&gt;<br />        &lt;config&gt;<br />            &lt;type&gt;select&lt;/type&gt;<br />            &lt;items type="array"&gt;<br />                &lt;numIndex index="1" type="array"&gt;<br />                    &lt;numIndex index="0"&gt;LLL:EXT:news/Resources/Private/Language/locallang_be.xlf:flexforms_general.recursive.I.inherit&lt;/numIndex&gt;<br />                    &lt;numIndex index="1"&gt;&lt;/numIndex&gt;<br />                &lt;/numIndex&gt;<br />                &lt;numIndex index="2" type="array"&gt;<br />                    &lt;numIndex index="0"&gt;LLL:EXT:frontend/Resources/Private/Language/locallang_ttc.xlf:recursive.I.0&lt;/numIndex&gt;<br />                    &lt;numIndex index="1"&gt;0&lt;/numIndex&gt;<br />                &lt;/numIndex&gt;<br />                &lt;numIndex index="3" type="array"&gt;<br />                    &lt;numIndex index="0"&gt;LLL:EXT:frontend/Resources/Private/Language/locallang_ttc.xlf:recursive.I.1&lt;/numIndex&gt;<br />                    &lt;numIndex index="1"&gt;1&lt;/numIndex&gt;<br />                &lt;/numIndex&gt;<br />                &lt;numIndex index="4" type="array"&gt;<br />                    &lt;numIndex index="0"&gt;LLL:EXT:frontend/Resources/Private/Language/locallang_ttc.xlf:recursive.I.2&lt;/numIndex&gt;<br />                    &lt;numIndex index="1"&gt;2&lt;/numIndex&gt;<br />                &lt;/numIndex&gt;<br />                &lt;numIndex index="5" type="array"&gt;<br />                    &lt;numIndex index="0"&gt;LLL:EXT:frontend/Resources/Private/Language/locallang_ttc.xlf:recursive.I.3&lt;/numIndex&gt;<br />                    &lt;numIndex index="1"&gt;3&lt;/numIndex&gt;<br />                &lt;/numIndex&gt;<br />                &lt;numIndex index="6" type="array"&gt;<br />                    &lt;numIndex index="0"&gt;LLL:EXT:frontend/Resources/Private/Language/locallang_ttc.xlf:recursive.I.4&lt;/numIndex&gt;<br />                    &lt;numIndex index="1"&gt;4&lt;/numIndex&gt;<br />                &lt;/numIndex&gt;<br />                &lt;numIndex index="7" type="array"&gt;<br />                    &lt;numIndex index="0"&gt;LLL:EXT:frontend/Resources/Private/Language/locallang_ttc.xlf:recursive.I.5&lt;/numIndex&gt;<br />                    &lt;numIndex index="1"&gt;250&lt;/numIndex&gt;<br />                &lt;/numIndex&gt;<br />            &lt;/items&gt;<br />        &lt;/config&gt;<br />    &lt;/TCEforms&gt;<br />&lt;/persistence.recursive&gt;<br /></code></pre><br />It is important, that the <b>field naming</b> of the fields is equal to the TypoScript naming. Since Extbase will merge all flexform fields to the plugin configuration, <b>persistence.storagePid</b> and <b>persistence.recursive</b>&nbsp;from the flexform will override the TypoScript settings.<br /><br /><b>Important note:</b><br />If you have set a storagePid by flexform and <i>delete it afterwards</i>, then the final storagePid will be <b>empty</b>. The reason for this is the field <i>pi_flexform</i> in <i>tt_content</i> table for the plugin, which will contain an empty value for persistence.storagePid<br /><br /><pre><code><br />&lt;field index="persistence.storagePid"&gt;<br />  &lt;value index="vDEF"&gt;&lt;/value&gt;<br />&lt;/field&gt;<br /></code></pre><br />This empty value actually overrides all other storagePid settings. You can avoid this behavior by using the&nbsp;<b>processDatamap_postProcessFieldArray hook</b> to unset empty field values in flexform if needed<br /><br /><h3>Conclusion</h3><br />As a result of this blogpost, I would recommend to use&nbsp;<b>plugin.tx_myext.persistence.storagePid </b>and<b>&nbsp;</b>the <b>record storage page</b> option to set the storagePid of a plugin, since it works out of the box and does not have any things to keep mind.<br /><br />