---
layout: post
title: TYPO3 7.3 - Extending the backend login form by using the new backend login
  form API
date: '2015-06-16T14:16:00.000+02:00'
author: Torben Hansen
tags:
- YubiKey
- TYPO3 7.3
- loginProvider
- backend login form API
modified_time: '2015-06-16T14:17:39.019+02:00'
thumbnail: http://4.bp.blogspot.com/-h1Yi7osOCNI/VXLWaxDSflI/AAAAAAAAOvc/pFTD7OQl8W8/s72-c/openid-link.png
blogger_id: tag:blogger.com,1999:blog-6517038209122183182.post-5787933766727164914
blogger_orig_url: http://www.derhansen.de/2015/06/extending-backend-login-form-in-typo3-7.3.html
permalink: /2015/06/extending-backend-login-form-in-typo3-7.3.html
---

Back in january 2015 I added support for <b>TYPO3 7.1</b> to the <b>YubiKey TYPO3 extension</b> and raised the extension compatibility level to be compatible with TYPO3 version 6.2.0 up to 7.99.99. When <b>TYPO3 7.2 </b>was released, I found out, that the YubiKey extension did'nt work any more with the new TYPO3 version, because the <b>TYPO3 backend login</b> has been <a href="https://forge.typo3.org/issues/66431" target="_blank">rewritten</a>. I debugged into the issue and found out, that the new backend login did not respect the template set in <b>$TBE_STYLES['htmlTemplates'][$tmplPath]</b>.<br /><br />It seemed I was not the only one having this problem, as another user already <a href="https://forge.typo3.org/issues/66669" target="_blank">reported</a> the same issue on forge. So with TYPO3 7.2+, you can't use $TBE_STYLES['htmlTemplates'][$tmplPath] to add own fields to the backend login form, since it is not supported any more.<br /><br />In this article I describe, how the new backend login form API is integrated in the <b>OpenID extension</b> and I also describe, how I <b>extended the username/passwors login provider</b> to add an additional field to the default backend login form.<br /><br /><h3>The new login form API in TYPO3 7.3</h3><br />In order to get the missing functionality of extending the backend login form back, the TYPO3 core developers added the&nbsp;<b>backend login form API</b> and also did a lot of <b>great work</b> refactoring the backend login. The backend login form API uses <b>login providers</b> to enable extension developers to add an own backend login form for e.g. an own <b>authentication service</b>. As an example, lets have a look at how the <b>OpenID authentication service</b> is integrated.<br /><br />The OpenID authentication service registers a <b>new login provider</b> by adding the following code in the file ext_localconf.php<br /><br /><script src="https://gist.github.com/derhansen/53f1498163158fc66061.js"></script><br />New login providers must add a new key to the array&nbsp;$GLOBALS['TYPO3_CONF_VARS']['EXTCONF']['backend']['loginProviders']. The new key must be an <b>unix timestamp</b> (unique for all login providers). The following array has the following keys:<br /><br /><ul><li>provider: The name of the login provider</li><li>sorting: Defines the sorting order in case of there are multiple login providers</li><li>icon-class: A class which defines the icon for the login provider</li><li>label: the label for the login provider&nbsp;</li></ul><br />Having the OpenID authentication service installed, the login provider of the OpenID extension adds a link to the backend login (see screenshot below).<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://4.bp.blogspot.com/-h1Yi7osOCNI/VXLWaxDSflI/AAAAAAAAOvc/pFTD7OQl8W8/s1600/openid-link.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="http://4.bp.blogspot.com/-h1Yi7osOCNI/VXLWaxDSflI/AAAAAAAAOvc/pFTD7OQl8W8/s1600/openid-link.png" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">TYPO3 7.3 backend login form showing the OpenID link</td></tr></tbody></table><div class="separator" style="clear: both; text-align: center;"></div>When you follow the "<b>Login with OpenID</b>" link, you come to an own login form showing the OpenID field (screenshot below).<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://2.bp.blogspot.com/-RsGZsIMd7Lk/VXLWa4grpTI/AAAAAAAAOvk/wIh9Z_oOxRY/s1600/openid-loginform.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="http://2.bp.blogspot.com/-RsGZsIMd7Lk/VXLWa4grpTI/AAAAAAAAOvk/wIh9Z_oOxRY/s1600/openid-loginform.png" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">TYPO3 7.3 OpenID login form</td></tr></tbody></table>From there, you have the possibility to <b>switch back to the username and password</b> login. This is, because also the username and password login has an own&nbsp;<b>login provider</b>.<br /><br />Lets have a look at the contents of the login provider class. <br /><br /><script src="https://gist.github.com/derhansen/bd71302aa201452e8cad.js"></script> As you can see, there is not much magic there. The <b>OpenidLoginProvider</b> implements the <b>LoginProviderInterface</b> and has only one method (render), which is called in the LoginController of the TYPO3 backend login form. In case of the OpenID extension, you see that <b>setTemplatePathAndFilename</b> is used to set the <b>Fluid template</b> for the OpenID login form.<br /><br /><script src="https://gist.github.com/derhansen/7c77b2adccc9aaaa4faf.js"></script> The template is kept really simple. It uses the layout "<b>Login</b>" (this is required) and has a section called "<b>loginFormFields</b>" (also required), which contains the OpenID login field. <br /><br /><h3>Integration of the backend login form API to the YubiKey extension</h3><br />For the YubiKey extension, I could have used the same technique as the OpenID extension does, but since some TYPO3 installations may <i>require</i> each user to use YubiKey two-factor authentication, it would be not very user-friendly to let a user <b>manually switch</b> to the YubiKey backend login provider when opening the TYPO3 backend login form.<br /><br />In order to add the YubiKey field to the backend login, I <b>extended the existing username and password login provider</b> with my own login form. In the ext_localconf.php, I added the following code.<br /><br /><script src="https://gist.github.com/derhansen/7c0d3f0380aeace29f11.js"></script> Next I created the YubiKey login provider, which calls the parent login provider (username and password) and sets the path to the Fluid template which contains the both the username and password fields and the YubiKey login field.<br /><br /><script src="https://gist.github.com/derhansen/db6afb25c594616c53de.js"></script> Note, that I <i>do not implement</i> the LoginProviderInterface, but <b>extend</b> the <b>UsernamePasswordLoginProvider</b>.<br /><br />Finally, after the YubiKey extension is installed and activated, the TYPO3 backend login now again has an additional field for the YubiKey two factor authentication (screenshot below)<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://2.bp.blogspot.com/-7mhV7LtOiaU/VXLWa5LdO_I/AAAAAAAAOvg/CnG4RgllyII/s1600/yubikey-loginform.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="320" src="http://2.bp.blogspot.com/-7mhV7LtOiaU/VXLWa5LdO_I/AAAAAAAAOvg/CnG4RgllyII/s320/yubikey-loginform.png" width="284" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">TYPO3 7.3 backend login with the additional YubiKey field</td></tr></tbody></table>As TYPO3 7.3 has been released yesterday, extension authors ,who created own authentication providers for the TYPO3 backend, can now start to implement the new backend login API to their extensions.<br /><br />The latest version 1.1.0 of the TYPO3 YubiKey extension uses the new backend login form API and is compatible with TYPO3 6.2 and TYPO3 7.x (except 7.2)<br /><br />