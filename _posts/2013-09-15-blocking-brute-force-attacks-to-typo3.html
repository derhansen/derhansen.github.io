---
layout: post
title: Blocking brute force attacks against the TYPO3 backend login using ModSecurity
date: '2013-09-15T13:48:00.001+02:00'
author: Torben Hansen
tags:
- ModSecurity
- brute force attack
- TYPO3
modified_time: '2013-09-15T13:52:20.297+02:00'
blogger_id: tag:blogger.com,1999:blog-6517038209122183182.post-826241879677102924
blogger_orig_url: http://www.derhansen.de/2013/09/blocking-brute-force-attacks-to-typo3.html
permalink: /2013/09/blocking-brute-force-attacks-to-typo3.html
---

Since the last few weeks I have noticed a constantly growing amount of <b>failed TYPO3 backend login attempts</b> on websites I administer. It seems I'm not alone with this problem, since a few other TYPO3 users are reporting the same issues. The method always seems to be the same - someone is doing a <b>brute force attack</b> against the password of the TYPO3 backend user "<b>admin</b>". The attack seems to be <b>automated</b>, takes <b>several hours</b> and comes from <b>various IP addresses</b> and from <b>different countries</b> in the world.<br /><br />If you do not have any TYPO3 backend account with the username "admin", you could just ignore the case that someone is trying to hack your TYPO3 installation. Well, since I have configured a [BE][warning_email_addr] my mailbox gets flooded with <b>thousands of emails</b> about failed TYPO3 login attempts.<br /><br />But what is the best way to handle and block those attacks? When I faced the first attack, I just <b>denied the IP address</b> of the attacker into the local <b>.htaccess</b> file of the TYPO3 installation. This method is implemented very quick, but always requires <i>manual steps</i> and is only valid for a given IP address. In the austrian TYPO3 forum I have <a href="http://forum.typo3.org/index.php?t=msg&amp;goto=694012&amp;" target="_blank">read</a> about a TYPO3 extension, which extends the TYPO3 backend login and is able to automatically blacklist IP addresses for failed login attempts. This idea seems to be good in general, but when you administer just more than one TYPO3 installation, the installation and configuration process of the extension can be very time consuming. I finally ended up with the solution, that once again <b>ModSecurity </b>seems to be the best way to handle this kind of attacks to TYPO3. During research I found an <a href="https://www.dongit.nl/tech/modsecurity-brute-force-protection" target="_blank">article</a> about <b>brute force protection</b> using ModSecurity. Sadly the rules did'nt fit out of the box into my setup, so I had to create my own ruleset.<br /><br />Below follows a ModSecurity ruleset, which <b>blocks the IP address</b> of an attacker for <b>10 minutes</b>, if there were more than <b>5 failed TYPO3 authentication attempts</b> from that IP address. Please note, that the ruleset only was tested with <b>ModSecurity 2.7.x</b> together with the <a href="https://owasp.org/index.php/Category:OWASP_ModSecurity_Core_Rule_Set_Project" target="_blank">OWASP ModSecurity Core Rule Set</a>.<br /><pre><code><br />&lt;IfModule mod_security2.c&gt;<br /><br />    #<br />    # TYPO3 backend login brute force protection<br />    #<br />    &lt;Location "/typo3/index.php"&gt;<br />        # Turn on security engine (if disabled)<br />        SecRuleEngine On<br /><br />        # Deny IP address if too many TYPO3 authentication failures<br />        SecRule IP:bf_block "@eq 1" \<br />        "id:'5000102', \<br />        msg:'IP address temporarily blocked due to too many TYPO3 authentication failures', \<br />        phase:2, \<br />        log, \<br />        deny"<br /><br />        # Check for TYPO3 authentication failure and increment counter<br />        SecRule RESPONSE_BODY "LOGIN_ERROR### begin" \<br />        "id:'5000100', \<br />        msg:'Failed TYPO3 authentication attempt', \<br />        phase:5, \<br />        t:none, \<br />        setvar:IP.bf_counter=+1, \<br />        expirevar:IP.bf_counter=3600, \<br />        nolog, \<br />        pass"<br /><br />        # Check for too many failures from a single IP address<br />        SecRule IP:bf_counter "@gt 5" \<br />        "id:'5000101', \<br />        msg:'Too many TYPO3 authentication failures from IP address', \<br />        phase:5, \<br />        t:none, \<br />        setvar:IP.bf_block, \<br />        setvar:!IP.bf_counter, \<br />        expirevar:IP.bf_block=600, \<br />        log, \<br />        pass"<br /><br />    &lt;/Location&gt;<br /><br />&lt;/ifModule&gt;<br /></code></pre><br />The ruleset creates a counter (IP.bf_counter) for each IP address, when a failed TYPO3 login is monitored. A failed login is identified by the string "LOGIN_ERROR### begin" in the response body. I don't check for the occourence of the string "<i>Your login attempt did not succeed</i>", since some TYPO3 installations may have a e.g. german or danish backend login and within this the resulting error message will be translated and the rule would not match.<br /><br />I've decided not to log each failed login attempt, since it fills up the ModSecurity audit log with the complete response from the TYPO3 backend login. If the counter is greater than 5, the counter is unset and a new variable (IP.bf_block) with a lifetime of 600 seconds is defined. Depending on this counter, the IP address gets blocked with a 403 error.<br /><br />If you have <b>blocked your own IP address</b> during to too many failed login attempts, you have to unset the counter variable by modifying your ruleset. This is not very practical, so another possibility to unset the variable is to simply delete the file <b>/tmp/ip.pag</b>&nbsp;- this is where ModSecurity stores all variables in a default setup. Note, that deleting the file will remove all variables set by ModSecurity. Also I don't know, if deleting the file will result in any other unwanted side-effects, so be carefull with that.<br /><br />Besides using ModSecurity to protect TYPO3 websites against known and unknown attacks, I also recommend using a <b>Yubikey</b> to add <b>two-factor authentication</b> to TYPO3 admin accounts.<br /><br /><br />