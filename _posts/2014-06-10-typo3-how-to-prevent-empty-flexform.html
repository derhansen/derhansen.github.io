---
layout: post
title: TYPO3 - How to prevent empty FlexForm values from getting saved
date: '2014-06-10T16:35:00.000+02:00'
author: Torben Hansen
tags:
- settings
- flexform
- empty values
- TYPO3
modified_time: '2014-06-10T19:12:38.700+02:00'
blogger_id: tag:blogger.com,1999:blog-6517038209122183182.post-4856815964281703404
blogger_orig_url: http://www.derhansen.de/2014/06/typo3-how-to-prevent-empty-flexform.html
permalink: /2014/06/typo3-how-to-prevent-empty-flexform.html
---

When you create an ExtBase extension you can use a <b>FlexForm</b> to enable the user to change some of the <b>TypoScript settings</b> you define for the extension directly in the <b>plugin settings</b>. As an example, you could assume that your ExtBase extension has the following TypoScript settings:<br /><pre><code><br />plugin.tx_myext {<br />  settings {<br />    myFirstSetting = A value<br />    mySecondSetting = Another value<br />  }<br />}<br /></code></pre><br />If you add a FlexForm to your extension with two input fields, where the user can change both "myFirstSetting" and "mySecondSetting", then you will be able to access the user configured settings in your extension controllers through an array which is available in <b>$this-&gt;settings</b>. But - if the user <strike>just configures one of the two settings</strike> resets an already set setting in FlexForm to an empty value, then the <b>second setting will be saved with an empty value</b> and you have to&nbsp;<b>merge</b>&nbsp;the <b>TypoScript</b> and <b>FlexForm</b> settings manually in your controller and manually control, which setting overrides each other.<br /><br />There has been a lot of discussion about this problem in the TYPO3 <a href="http://lists.typo3.org/pipermail/typo3-dev/2011-June/043467.html" target="_blank">mailinglist</a> and on forge and as far as I could find out, a solution is'nt implemented very easy, since you have to decide for each individual field, if you want to let an empty Flexform setting override a predefined TypoScript setting. Georg Ringer did a lot of work on handling this override-behaviour in his great News-Extension, where you define a TypoScript setting named "overrideFlexformSettingsIfEmpty", which contains all fields which should be overridden by TypoScript values, if the FlexForm contains empty values.<br /><br />There is nothing wrong with the solution show in the News-Extension and in the ExtBase <a href="http://forge.typo3.org/projects/typo3v4-mvc/wiki/How_to_control_override_of_TS-Flexform_configuration" target="_blank">Wiki</a>, but I took a different approach and tried to find out if it is possible to <b>prevent empty FlexForm values from getting saved</b> to the database when the plugin configuration is saved, so you don't have to do the merge/override manually.<br /><br />Outgoing from the example described above the table <b>tt_content</b> contains a record for the ExtBase plugin, which holds the FlexForm configuration as <b>XML</b>. For the case, that the user just configured one of the two settings by FlexForm, the content in the field <b>pi_flexform</b> contains the following:<br /><br /><pre><code><br />&lt;?xml version="1.0" encoding="utf-8" standalone="yes" ?&gt;<br />&lt;T3FlexForms&gt;<br />    &lt;data&gt;<br />        &lt;sheet index="sDEF"&gt;<br />            &lt;language index="lDEF"&gt;<br />                &lt;field index="settings.myFirstSetting"&gt;<br />                    &lt;value index="vDEF"&gt;A value&lt;/value&gt;<br />                &lt;/field&gt;<br />                &lt;field index="settings.mySecondSetting"&gt;<br />                    &lt;value index="vDEF"&gt;&lt;/value&gt;<br />                &lt;/field&gt;<br />            &lt;/language&gt;<br />        &lt;/sheet&gt;<br />    &lt;/data&gt;<br />&lt;/T3FlexForms&gt;<br /></code></pre><br />You will notice, that the setting <b>mySecondSetting</b> contains an <b>empty value</b>. This is the field I want to remove from the XML when saving the plugin configuration, since the setting should be overridden by the default value configured in TypoScript.<br /><br />To do so, I used the TYPO3 core hook<b>&nbsp;processDatamap_postProcessFieldArray</b>, which allows me to modify the values being written to the database.<br /><br />In <b>ext_localconf.php</b> I define the class to use for the DataHandler hook.<br /><br /><pre><code><br />// DataHandler hook<br />$GLOBALS['TYPO3_CONF_VARS']['SC_OPTIONS']['t3lib/class.t3lib_tcemain.php']['processDatamapClass']['NAMESPACE.' . $_EXTKEY] = 'NAMESPACE\MyExt\Hooks\DataHandlerHooks';<br /></code></pre><br />Next I created the class containing the new <b>processDatamap_postProcessFieldArray</b> function. The contents of the file is as following.<br /><br /><pre><code><br />&lt;?php<br />namespace NAMESPACE\MyExt\Hooks;<br /><br />/***************************************************************<br /> *<br /> *  Copyright notice<br /> *<br /> *  (c) 2014 Torben Hansen &lt;derhansen@gmail.com&gt;<br /> *<br /> *  All rights reserved<br /> *<br /> *  This script is part of the TYPO3 project. The TYPO3 project is<br /> *  free software; you can redistribute it and/or modify<br /> *  it under the terms of the GNU General Public License as published by<br /> *  the Free Software Foundation; either version 3 of the License, or<br /> *  (at your option) any later version.<br /> *<br /> *  The GNU General Public License can be found at<br /> *  http://www.gnu.org/copyleft/gpl.html.<br /> *<br /> *  This script is distributed in the hope that it will be useful,<br /> *  but WITHOUT ANY WARRANTY; without even the implied warranty of<br /> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the<br /> *  GNU General Public License for more details.<br /> *<br /> *  This copyright notice MUST APPEAR in all copies of the script!<br /> ***************************************************************/<br /><br />use TYPO3\CMS\Core\Utility\GeneralUtility;<br /><br />/**<br /> * Hooks for DataHandler<br /> */<br />class DataHandlerHooks {<br /><br /> /**<br />  * Checks if the fields defined in $checkFields are set in the data-array of pi_flexform. If a field is<br />  * present and contains an empty value, the field is unset.<br />  *<br />  * Structure of the checkFields array:<br />  *<br />  * array('sheet' =&gt; array('field1', 'field2'));<br />  *<br />  * @param string $status<br />  * @param string $table<br />  * @param string $id<br />  * @param array $fieldArray<br />  * @param \TYPO3\CMS\Core\DataHandling\DataHandler $reference<br />  *<br />  * @return void<br />  */<br /> public function processDatamap_postProcessFieldArray($status, $table, $id, &amp;$fieldArray, &amp;$reference) {<br />  if ($table === 'tt_content' &amp;&amp; $status == 'update' &amp;&amp; isset($fieldArray['pi_flexform'])) {<br />   $checkFields = array(<br />    'sDEF' =&gt; array(<br />     'settings.myFirstSetting',<br />     'settings.mySecondSetting'<br />    ),<br />   );<br /><br />   $flexformData =  GeneralUtility::xml2array($fieldArray['pi_flexform']);<br /><br />   foreach ($checkFields as $sheet =&gt; $fields) {<br />    foreach($fields as $field) {<br />     if (isset($flexformData['data'][$sheet]['lDEF'][$field]['vDEF']) &amp;&amp;<br />      $flexformData['data'][$sheet]['lDEF'][$field]['vDEF'] === '') {<br />      unset($flexformData['data'][$sheet]['lDEF'][$field]);<br />     }<br />    }<br /><br />    // If remaining sheet does not contain fields, then remove the sheet<br />    if (isset($flexformData['data'][$sheet]['lDEF']) &amp;&amp; $flexformData['data'][$sheet]['lDEF'] === array()) {<br />     unset($flexformData['data'][$sheet]);<br />    }<br />   }<br /><br />   /** @var \TYPO3\CMS\Core\Configuration\FlexForm\FlexFormTools $flexFormTools */<br />   $flexFormTools = GeneralUtility::makeInstance('TYPO3\\CMS\\Core\\Configuration\\FlexForm\\FlexFormTools');<br />   $fieldArray['pi_flexform'] = $flexFormTools-&gt;flexArray2Xml($flexformData, TRUE);<br />  }<br /> }<br /><br />}<br /></code></pre><br />In the function I have defined an array which holds <b>sheet-</b>&nbsp;and <b>fieldnames</b>, which should be removed if empty. Next I iterate through all sheets and fields configured in <b>$checkFields</b> to check, if they really are empty and if so, I just remove them from the array.<br /><br />You may notice, that I <b>converted</b> the given <b>XML</b> structure to an array, so I can easily iterate through all sheets/fields. When everything is finished, I use the TYPO3 <b>FlexFormTools</b> to convert the array back to FlexForm XML.<br /><br />After implementing the new function by the hook, the resulting FlexForm does not contain fields with empty values as defined in my function and I can now use <b>$this-&gt;settings</b> in my controller (or retrieving the settings through the configurationManager) without the need to manually merge/override TypoScript and FlexForm settings.<br /><br />Please note, that I just tested the above with TYPO3 6.2.<br /><br />