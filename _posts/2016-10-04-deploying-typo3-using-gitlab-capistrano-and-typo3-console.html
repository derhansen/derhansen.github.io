---
layout: post
title: Testing and deploying TYPO3 using GitLab, GitLab CI, Capistrano and TYPO3 Console
date: '2016-10-04T09:32:00.000+02:00'
author: Torben Hansen
tags:
- Capistrano
- GitLab
- Continuous Deployment
- GitLab CI
- TYPO3 Console
- TYPO3
- continuous integration
modified_time: '2016-10-04T09:32:22.824+02:00'
thumbnail: https://2.bp.blogspot.com/-sv9mpm9mAN4/V-0kNhO69mI/AAAAAAAASb8/hOkbhub9SyAByP4LYERDTcAeZwa1I9M7gCLcB/s72-c/Bildschirmfoto%2B2016-09-29%2Bum%2B16.23.09.png
blogger_id: tag:blogger.com,1999:blog-6517038209122183182.post-4114996449039767109
blogger_orig_url: http://www.derhansen.de/2016/10/deploying-typo3-using-gitlab-capistrano-and-typo3-console.html
permalink: /2016/10/deploying-typo3-using-gitlab-capistrano-and-typo3-console.html
---

In this article, I'll show you how to setup automated testing and continuous deployment of a TYPO3 website using <b><a href="https://gitlab.com/gitlab-org/gitlab-ce" target="_blank">GitLab</a></b>, <b><a href="https://gitlab.com/gitlab-org/gitlab-ci-multi-runner" target="_blank">GitLab CI</a></b>, <b><a href="http://capistranorb.com/" target="_blank">Capistrano</a></b> and <b><a href="https://github.com/helhum/typo3_console" target="_blank">TYPO3 Console</a></b>. The main purpose of the article is to give you a&nbsp;<i>starting point</i> for automated testing and&nbsp;continuous&nbsp;deployment.<br /><br />With the setup described in this article, I want to make sure, that<br /><ul><li>tests are executed automatically on every commit</li><li>pushes to master branch will automatically be deployed to the production server</li><li>deployment will only execute, when tests pass</li></ul><br />I tried to keep write the article as simple as possible, so please note, that some features / processes of real life automated deployment scenarios are not covered.<br /><br /><b>Prerequisites:</b><br /><ul><li>A <b>composer based TYPO3</b> website with a basic site package</li><li>At least one TYPO3 extension with tests</li><li>A working GitLab server (I'm using an own instance of the Community Edition)</li><li>A GitLab CI runner</li><li>A SSH account on the webspace, where you want the TYPO3 website to be deployed</li><li>Ruby version 1.9.3 or newer on your local machine (required for capistrano)</li></ul><div><br /><a href="http://gitlab.com/">GitLab.com</a> offers <i>free private repositories</i> and also access to GitLab CI runners, so I'm pretty sure, that the setup I described here may even work using the GitLab.com infrastructure.<br /><br /></div><div><h3></h3><h3>1. Structure of the composer based TYPO3 website</h3></div><div><br />The TYPO3 website used for this blogpost is a really simple composer based TYPO3 website. It contains a sitepackage with TypoScript and a Fluid template and it contains the TYPO3 extension <a href="https://typo3.org/extensions/repository/view/sf_yubikey" target="_blank">sf_yubikey</a>, which is used in this example to execute some unit tests. Also the TYPO3 website contains the TYPO3 extension <a href="https://github.com/TYPO3-Console/typo3_console" target="_blank">typo3_console</a>, which will be used in the deployment process.&nbsp;</div><div><br /></div><div>Unit tests can be executed on CLI with the command shown below:</div><div><pre><code class="zsh">./vendor/bin/phpunit -c web/typo3conf/ext/sf_yubikey/Tests/Build/UnitTests.xml</code></pre></div><div><br /></div><div>My composer.json file contains the following contents:</div><pre><code class="json">{<br /> "repositories": [<br />  { "type": "composer", "url": "https://composer.typo3.org/" }<br /> ],<br /> "name": "typo3/cms-base-distribution",<br /> "description" : "TYPO3 CMS Base Distribution",<br /> "license": "GPL-2.0+",<br /> "require": {<br />  "typo3/cms": "^7.6",<br />  "typo3-ter/sf-yubikey": "*",<br />  "helhum/typo3-console": "^3.3"<br /> },<br /> "require-dev": {<br />   "mikey179/vfsStream": "1.4.*@dev",<br />   "phpunit/phpunit": "~4.7.0"<br /> },<br /> "extra": {<br />  "typo3/cms": {<br />   "cms-package-dir": "{$vendor-dir}/typo3/cms",<br />   "web-dir": "web"<br />  },<br />  "helhum/typo3-console": {<br />   "install-binary": false<br />  }<br /> }<br />}<br /></code></pre><div><br />Note, that I use <b>helhum/typo3-console </b>(not from TER), which on install makes the typo3cms command available in the <i>vendor/bin</i> directory.<br /><br />The TYPO3 installation also contains a backend user named&nbsp;<b>_cli_lowlevel</b>, which is required to execute CLI commands.<br /><br /></div><div><h3>2. Move all sensitive data and local settings out of the LocalConfiguration.php</h3></div><div><br />You should never commit any sensitive data (like passwords or API keys) to a Git repository, so I move those settings out of from LocalConfiguration.php to the file AdditionalConfiguration.php, which also is located in the typo3conf/ folder.</div><div><br /></div><div>The local AdditionalConfiguration.php file used in this blogpost looks like shown below:</div><div><br /></div><pre><code class="php">&lt;?php<br />$GLOBALS['TYPO3_CONF_VARS']['DB']['database'] = 'typo3db';<br />$GLOBALS['TYPO3_CONF_VARS']['DB']['host']     = 'localhost';<br />$GLOBALS['TYPO3_CONF_VARS']['DB']['username'] = 'dbusername';<br />$GLOBALS['TYPO3_CONF_VARS']['DB']['password'] = 'dbpassword';<br /><br />$GLOBALS['TYPO3_CONF_VARS']['BE']['installToolPassword'] = 'hashvalue';<br /><br />$GLOBALS['TYPO3_CONF_VARS']['GFX']['im_path'] = '/opt/local/bin/';<br />$GLOBALS['TYPO3_CONF_VARS']['GFX']['im_path_lzw'] = '/opt/local/bin/';<br /></code></pre><div><br />Besides all sensitive data from the LocalConfiguration.php, the AdditionalConfiguration.php file should include all settings, that should not be shared across deployment stages.<br /><br /></div><div><h3>3. Modify the default .gitignore, so some TYPO3 directories will not be included in the git repository</h3></div><div><br /></div><div>For the TYPO3 website in this blogpost, I extended the default .gitignore file, so contents of some TYPO3 directories and files do not get committed to the git repository (e.g. fileadmin, uploads or all extensions installed by composer)</div><div><br /></div><pre><code class="zsh">#############################<br /># TYPO3 CMS Base Distribution<br />#############################<br />.DS_Store<br />.idea<br />index.php<br />nbproject<br />node_modules<br />vendor<br />typo3<br />typo3_src<br />web/index.php<br />web/typo3<br /><br /># Ignore fileadmin, uploads and typo3temp<br />web/fileadmin<br />web/uploads<br />web/typo3temp<br /><br /># Ignore some files in typo3conf<br />web/typo3conf/ENABLE_INSTALL_TOOL<br />web/typo3conf/AdditionalConfiguration.php<br />web/typo3conf/*.log<br /><br /># Ignore language files (fetched by TYPO3 console)<br />web/typo3conf/l10n<br /><br /># Ignore all extensions (loaded by composer)<br />web/typo3conf/ext/*<br /><br /># But include the sitepackage, which is not composer based<br />!web/typo3conf/ext/sitepackage<br /><br /># Ignore capistrano deployment logs<br />log<br /></code></pre><div><br /></div><div><h3><b>4. Commit the TYPO3 website to a git repository</b></h3></div><div><br /></div><div>The .gitignore file is ready, so now I create a new git repository and add / commit all files to it. Finally, I create a new project on the <b>GitLab server</b> and add the repository as a remote for the local git repository and finally push the repository to the remote.<br /><br /></div><pre><code class="zsh">git remote add origin git@gitlab.com:derhansen/typo3_ci_cd.git<br />git push -u origin master<br /></code></pre><div><h3><br /><b>5. Configure deployment of TYPO3 website with capistrano</b></h3></div><br /><u>5.1 SSH setup for deployment to webserver</u><br /><br />First, I add my public SSH RSA key to the .<b>ssh/authorized_keys</b> file in the home-directory of the SSH user on the webserver, so I'm able to login by using SSH key authentication. This step is not required, but makes deployment from my local machine to the webserver easier.<br /><br />Next I create a <b>new SSH RSA key</b> on the webserver (like shown <a href="https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/" target="_blank">here</a>), so the SSH user will be able to pull from the remote git repository on the GitLab server I created in step 4. This SSH RSA Key will be the <b>deployment key</b> and must not contain a password.<br /><br />The new <b>SSH public key</b> must now be added to the git repository on the GitLab server. In order to do so, I add it as Deployment Key for the project (see screenshot below)<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-sv9mpm9mAN4/V-0kNhO69mI/AAAAAAAASb8/hOkbhub9SyAByP4LYERDTcAeZwa1I9M7gCLcB/s1600/Bildschirmfoto%2B2016-09-29%2Bum%2B16.23.09.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="177" src="https://2.bp.blogspot.com/-sv9mpm9mAN4/V-0kNhO69mI/AAAAAAAASb8/hOkbhub9SyAByP4LYERDTcAeZwa1I9M7gCLcB/s640/Bildschirmfoto%2B2016-09-29%2Bum%2B16.23.09.png" width="640" /></a></div><br /><u>5.2 Initialize and configure capistrano</u><br /><br />I have chosen capistrano as the deployment tool for the TYPO3 website, because it is well documented, has a large user base and is easy to use/extend. If you do not like capistrano, it should be easy to replace capistrano with the deployment tool of your choice (e.g. TYPO3 surf, Deployer, Magallanes, ...)<br /><br />In the project root of my local composer based TYPO3 website, I now initialize a new capistrano config with the following command:<br /><br /><pre><code class="zsh">cap install</code></pre><br />First of all, I remove everything in the file <b>config/deploy/production.rb</b> and add the following content:<br /><br /><pre><code class="ruby">server 'typo3-ci-cd.domain.tld',<br />  user: 'typo3cicd',<br />  roles: %w{app db web}</code></pre><br />Next, I create a really basic deployment in <b>config/deploy.rb</b>, which mainly executes composer install and executes some TYPO3 tasks using TYPO3 console.<br /><br /><pre><code class="ruby"># config valid only for current version of Capistrano<br />lock '3.6.1'<br /><br />set :application, 'typo3_ci_cd'<br />set :repo_url, 'git@path-to-my-gitlab:torben/typo3_ci_cd.git'<br />set :deploy_to, '/var/www/typo3-ci-cd/httpdocs'<br />set :scm, :git<br />set :keep_releases, 5<br />set :linked_dirs, %w{web/fileadmin web/uploads}<br />set :linked_files, %w{web/typo3conf/AdditionalConfiguration.php}<br /><br />namespace :composer do<br />    desc "Runs composer."<br />    task :install do<br />        on roles(:web) do<br />            within release_path do<br />                execute "composer", "install", "--no-dev", "--no-interaction", "--prefer-dist"<br />            end<br />        end<br />    end<br />end<br /><br />namespace :typo3 do<br /><br />    desc "Clear TYPO3 Cache"<br />    task :cache_flush do<br />        on roles(:all) do<br />            within release_path do<br />                execute "#{release_path}/vendor/bin/typo3cms cache:flush"<br />            end<br />        end<br />    end<br /><br />    desc "Update language"<br />    task :language_update do<br />        on roles(:all) do<br />            within release_path do<br />                execute "#{release_path}/vendor/bin/typo3cms language:update"<br />            end<br />        end<br />    end<br /><br />end<br /><br />namespace :deploy do<br />    after :publishing, "composer:install"<br />    after :finishing,  "typo3:cache_flush"<br />    after :finishing,  "typo3:language_update"<br />end<br /></code></pre><br />You may note the file AdditionalConfiguration.php in the <b>linked_files</b> section of the deployment configuration. This is required in order to get TYPO3 running, when I'm doing a deployment from my local machine.<br /><br />The <b>linked_dirs</b> section contains the folders <b>web/fileadmin</b>&nbsp;and <b>web/uploads</b>, which I want to share across deployments, since users will upload files to it.<br /><br /><u>5.3 Manual steps before first deployment</u><br /><br />Before the first deployment can be executed, there are some steps, that need to be done manually on the webserver.<br /><br /><i>5.3.1 Initial shared folder setup</i><br /><br />I copy the contents of the directories <b>fileadmin/</b> and <b>uploads/</b> from my local TYPO3 website to the directory <b>shared/web</b> in the deployment path (see "deploy_to" in the deploy.rb file). The final directory structure is as shown below (Note: .htaccess files are not shown).<br /><br /><pre><code class="zsh">shared/<br />└── web<br />    ├── fileadmin<br />    │&nbsp;&nbsp; ├── _temp_<br />    │&nbsp;&nbsp; │&nbsp;&nbsp; └── index.html<br />    │&nbsp;&nbsp; └── user_upload<br />    │&nbsp;&nbsp;     ├── index.html<br />    │&nbsp;&nbsp;     └── _temp_<br />    │&nbsp;&nbsp;         ├── importexport<br />    │&nbsp;&nbsp;         │&nbsp;&nbsp; └── index.html<br />    │&nbsp;&nbsp;         └── index.html<br />    ├── typo3conf<br />    │&nbsp;&nbsp; └── AdditionalConfiguration.php<br />    └── uploads<br />        ├── index.html<br />        ├── media<br />        │&nbsp;&nbsp; └── index.html<br />        ├── pics<br />        │&nbsp;&nbsp; └── index.html<br />        └── tx_felogin<br /></code></pre><div class="separator" style="clear: both; text-align: center;"></div><br /><div class="separator" style="clear: both; text-align: center;"></div>The shared folder does also contains the <b>typo3conf/</b> directory, where I add the <b>AdditionalConfiguration.php</b> and modify the settings (e.g. database credentials, GraphicsMagick path, ...) to match the server configuration.<br /><br /><i>5.3.2 Initial database setup</i><br /><br />Since there is no initial TYPO3 database on the webserver, I create a local dump of the TYPO3 database and restore it to the remote database on the webserver.<br /><br /><i>5.4 Initial deployment</i><br /><br />Now it is time to do the first deployment form my local machine, so I execute the deployment with the following command<br /><br /><pre><code class="zsh">cap production deploy</code></pre><br />Capistrano now executes the deployment and after finishing, I have a fully working copy of my local TYPO3 website on the remote webserver.<br /><br />Capistrano creates the directories <b>current/</b>, <b>releases/</b>, <b>repo/</b> and <b>shared/.</b>&nbsp;The current version of the deployed TYPO3 website is available in the current/ directory, so I adjusted the webserver to load the website from that directory.<br /><br /><i>5.5 Commit deployment configuration</i><br /><br />Finally I commit the deployment configuration to the git repository, so it later can be used for the automated deployment.<br /><br /><h3><b>6. Configure automated test execution on GitLab server</b></h3><b><br /></b>In an automated deployment process, you need to make sure, that only working versions of your website will be deployed to the production server. In this example, I simply run the unit tests of a TYPO3 extension to demonstrate, how automatic test execution can be a part of a deployment process. In real life scenarios, you can for example use unit, functional or acceptance tests to make sure, that your website will run smoothly after deployment.<br /><br />In my local project, I create the file&nbsp;<b>.gitlab-ci.yml</b> and add the following contents to it:<br /><br /><pre><code class="yaml">stages:<br />  - tests<br /><br />phpunit:php7.0:<br />  stage: tests<br />  image: php:7.0<br />  before_script:<br />    - apt-get update -yqq<br />    - apt-get install git libcurl4-gnutls-dev libicu-dev libvpx-dev libjpeg-dev libpng-dev libxpm-dev zlib1g-dev libfreetype6-dev libxml2-dev libexpat1-dev libbz2-dev libgmp3-dev libldap2-dev unixodbc-dev libpq-dev libsqlite3-dev libaspell-dev libsnmp-dev libpcre3-dev libtidy-dev -yqq<br />    - docker-php-ext-install mbstring zip<br />    - curl -sS https://getcomposer.org/installer | php<br />  script:<br />    - php composer.phar install<br />    - php vendor/bin/phpunit --colors -c web/typo3conf/ext/sf_yubikey/Tests/Build/UnitTests.xml<br /></code></pre><br />I add and commit the file to the git repository and push the changes to the remote. Now GitLab CI will start a <b>PHP 7.0</b> <b>docker container</b>, install all dependencies and finally run the configured unit tests.<br /><br />Nice, the build passed....<br /><div><br /></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-z1o9hsleDXc/V-44k3MjNpI/AAAAAAAASdc/NLHPYSblJhMMWlaYgzkyzEv7ggh531y2wCLcB/s1600/build-green.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="96" src="https://1.bp.blogspot.com/-z1o9hsleDXc/V-44k3MjNpI/AAAAAAAASdc/NLHPYSblJhMMWlaYgzkyzEv7ggh531y2wCLcB/s640/build-green.png" width="640" /></a></div><br /><br />...and unit tests have been executed on the GitLab CI runner.<br /><div><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-RA9CM2JMIis/V-448v41oqI/AAAAAAAASdg/28XyjVzKrB0N74mXFGsqUoovy3yxv-PgQCLcB/s1600/unit-tests.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="153" src="https://2.bp.blogspot.com/-RA9CM2JMIis/V-448v41oqI/AAAAAAAASdg/28XyjVzKrB0N74mXFGsqUoovy3yxv-PgQCLcB/s640/unit-tests.png" width="640" /></a></div><br />You may notice, that the build took <i>3:16 minutes</i> to finish, which is pretty long just for unit test execution. To reduce the build time, I suggest to <a href="https://docs.docker.com/engine/tutorials/dockerimages/#/building-an-image-from-a-dockerfile" target="_blank">create your own docker image</a> with all dependencies included.<br /><br />If you want to <b>receive e-mail notifications</b> on builds (or only for failed builds), you can enable this feature in the <a href="https://docs.gitlab.com/ce/project_services/builds_emails.html" target="_blank">service section</a> of the GitLab project.<br /><br /><h3><b>7. Configure automated deployment on GitLab server</b></h3><br />As a final step, I want to automate the deployment of the website, when commits are made to the master branch and if tests passed. Since the GitLab CI runner will do the deployment, it must be able to SSH to the production website.<br /><br />I create a new SSH RSA key (with no password), which will be used for the deployment from the GitLab CI runner to the production webserver. After adding the <b>SSH public key</b> to the <b>ssh/authorized_keys</b> file of the SSH user on the webserver, I create a new variable in the GitLab project and add the new private key to it.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-6xPGzg-nia0/V-4-7KybrYI/AAAAAAAASd0/755SO9DDL9MyK0FqGhMDruPcrnLAVdURACLcB/s1600/ssh-private-key-variable.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="136" src="https://3.bp.blogspot.com/-6xPGzg-nia0/V-4-7KybrYI/AAAAAAAASd0/755SO9DDL9MyK0FqGhMDruPcrnLAVdURACLcB/s640/ssh-private-key-variable.png" width="640" /></a></div><br />Next, I extend the <b>.gitlab-ci.yml</b> to use the <b>SSH_PRIVATE_KEY</b> variable in the docker container, that will do the deployment. Detailed instructions can be found in the <a href="https://docs.gitlab.com/ce/ci/ssh_keys/README.html" target="_blank">GitLab CI documentation</a>. The final configuration file looks like shown below:<br /><br /><pre><code class="yaml">stages:<br />  - test<br />  - deploy<br /><br />phpunit:php7.0:<br />  stage: test<br />  image: php:7.0<br />  before_script:<br />    - apt-get update -yqq<br />    - apt-get install git libcurl4-gnutls-dev libicu-dev libvpx-dev libjpeg-dev libpng-dev libxpm-dev zlib1g-dev libfreetype6-dev libxml2-dev libexpat1-dev libbz2-dev libgmp3-dev libldap2-dev unixodbc-dev libpq-dev libsqlite3-dev libaspell-dev libsnmp-dev libpcre3-dev libtidy-dev -yqq<br />    - docker-php-ext-install mbstring zip<br />    - curl -sS https://getcomposer.org/installer | php<br />  script:<br />    - php composer.phar install<br />    - php vendor/bin/phpunit --colors -c web/typo3conf/ext/sf_yubikey/Tests/Build/UnitTests.xml<br /><br />deployment:<br />  stage: deploy<br />  image: ruby:2.3<br />  before_script:<br />    - 'which ssh-agent || ( apt-get update -y &amp;&amp; apt-get install openssh-client -y )'<br />    - eval $(ssh-agent -s)<br />    - ssh-add &lt;(echo "$SSH_PRIVATE_KEY")<br />    - mkdir -p ~/.ssh<br />    - '[[ -f /.dockerenv ]] &amp;&amp; echo -e "Host *\n\tStrictHostKeyChecking no\n\n" &gt; ~/.ssh/config'<br />  script:<br />    - gem install capistrano<br />    - cap production deploy<br />  only:<br />    - master<br /></code></pre><br />Since capistrano is a ruby application, I use a<b>&nbsp;docker container</b>&nbsp;<b>with ruby</b> for the deployment.<br /><br />Finally, after committing the changes to the repository, the GitLab CI runner runs the build and deploys the TYPO3 website to the production server.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-18w3OY5cYAo/V-5O2SuocKI/AAAAAAAASeE/qdpqWx0aBjM4dPOnbirBowrc3bw89rPBgCLcB/s1600/deployment-pipe.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="94" src="https://3.bp.blogspot.com/-18w3OY5cYAo/V-5O2SuocKI/AAAAAAAASeE/qdpqWx0aBjM4dPOnbirBowrc3bw89rPBgCLcB/s640/deployment-pipe.png" width="640" /></a></div><br /><br />And that's it, the automated testing and continuous deployment setup for TYPO3 is up and running.<br /><br /><h3>Outlook and conclusion</h3><br />There are for sure some things that can be improved in the process I described in this post. For example, you could also add the AdditionalConfiguration.php file as a secret variable to the GitLab project and use the GitLab CI Mutli-Runner to deploy it to the production server. Also you can automate TYPO3 related tasks using TYPO3 console (e.g. database updates on new extension installation with <i>typo3cms database:updateschema</i>, update reference index, ...).<br /><br />I hope the post will give you a good point of how/where to start with automating tests and continuous deployment of a TYPO3 website. The shown technique is <i>just one way</i> of how to setup and automate the process - feel free to build your own configuration with the tools of your choice and please share your knowledge :-)