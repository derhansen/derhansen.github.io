---
layout: post
title: Unit-, Functional- and Acceptance-Tests for a TYPO3 Extension with GitHub Actions
date: '2020-05-05T13:48:00.003+02:00'
author: Torben Hansen
tags:
- Composer
- GitHub Actions
- tests
- TYPO3
- PHP
- codeception
modified_time: '2020-05-29T18:57:01.171+02:00'
thumbnail: https://1.bp.blogspot.com/-JCACPtrja2I/XrBh2l6zcjI/AAAAAAAAltc/zgSHXtiJVqw6RTPL1qwUh45O4m3PCJqHACLcBGAsYHQ/s72-c/Bildschirmfoto%2B2020-05-04%2Bum%2B20.41.08.png
blogger_id: tag:blogger.com,1999:blog-6517038209122183182.post-1203751285973222116
blogger_orig_url: http://www.derhansen.de/2020/05/typo3-extension-testing-with-github-actions.html
permalink: /2020/05/typo3-extension-testing-with-github-actions.html
---

Back in 2017 at TYPO3 Camp Munich I held a talk about&nbsp;Unit-, Functional- and Acceptance-Tests for a TYPO3 Extension with GitLab CI. I never really used that setup for my Open Source Extensions, since they all are hosted on <a href="https://github.com/derhansen" target="_blank">GitHub</a>. But since november 2019 GitHub Actions are available, so I finally took some time to migrate my GitLab CI Build Pipeline to GitHub Actions. The results of this migration process is available on GitHub and summarized in this blogpost.<br /><br />To keep things simple, I created a little demo Extension for TYPO3 to make the setup as easy and understandable as possible.<br /><br />All in all, the results are very satisfying and the build process is&nbsp;<b>really fast&nbsp;</b>without the requirement to use additional docker images (e.g. MySQL or Selenium Standalone). GitHub has really done a great job by providing preconfigured hosted runners with lots of useful tools&nbsp;üëç<br /><br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-JCACPtrja2I/XrBh2l6zcjI/AAAAAAAAltc/zgSHXtiJVqw6RTPL1qwUh45O4m3PCJqHACLcBGAsYHQ/s1600/Bildschirmfoto%2B2020-05-04%2Bum%2B20.41.08.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="764" data-original-width="1330" height="366" src="https://1.bp.blogspot.com/-JCACPtrja2I/XrBh2l6zcjI/AAAAAAAAltc/zgSHXtiJVqw6RTPL1qwUh45O4m3PCJqHACLcBGAsYHQ/s640/Bildschirmfoto%2B2020-05-04%2Bum%2B20.41.08.png" width="640" /></a></div><br /><br />The GitHub Repository with all sources and the GitHub Actions workflow is available at&nbsp;<a href="https://github.com/derhansen/gha_demo">https://github.com/derhansen/gha_demo</a>.<br /><br />During creation of the setup, I ran into some issues, that took me some time to figure out. All issues are easy to resolve and I summarized them in the <b>"Good to know"-section</b> at the end of this article.<br /><br /><h3>TYPO3 demo extension "gha_demo"</h3><br />The repository includes a very simple TYPO3 extension that basically does nothing special. It has a simple domain model with just one field and a simple plugin that shows all records of the domain model. The extension has the following tests<br /><br /><ul><li>Unit Tests for the domain model</li><li>Functional Tests for the repository</li><li>Acceptance Tests (based on codeception) for the plugin output</li></ul><br />Before I created the GitHub Actions workflow, I ensured that all tests execute properly in my local development environment.<br /><br /><h3>GitHub-hosted virtual environments</h3><br />GitHub hosted runners are <a href="https://help.github.com/en/actions/reference/software-installed-on-github-hosted-runners" target="_blank">preconfigured</a> runners that already contain <b>a lot of available software</b>&nbsp;(e.g. composer, PHP in various versions, Google Chrome, Selenium) that can be used to test an application. No need to puzzle around with building or pulling docker images that contain requirements and no waste of build time to install required packages.<br /><br />For the gha_demo TYPO3 extension I use the&nbsp;Ubuntu 18.04 LTS runner only without any other docker images.<br /><br /><h3>Workflow YAML file</h3><br />It is very easy to enable GitHub Actions for a repository. You create a directory called&nbsp;<i>.github/workflows</i>&nbsp;and add a YAML file with your workflow configuration that must follow the&nbsp;<a href="https://help.github.com/en/actions/reference/workflow-syntax-for-github-actions" target="_blank">Workflow Syntax for GitHub Actions</a>.<br /><br />The workflow YAML file I created for this article is (hopefully) self explaining:<br /><a href="https://github.com/derhansen/gha_demo/blob/master/.github/workflows/ci.yml">https://github.com/derhansen/gha_demo/blob/master/.github/workflows/ci.yml</a><br /><br />The workflow uses 3 GitHub actions. The first action "<i>actions/checkout"</i>&nbsp;just checks out the GitHub repository.<br /><br />The second action <i>"actions/cache"</i> ensures, that Composer cache files are shared for builds. You just have to configure a unique key for the cache and I choose to use the hash of the composer.json as a key, so every time dependencies change, the cache is rebuilt. To ensure, that the cache is working you should see "loading from cache" in the output of the composer command.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-3eHQeW8ExVQ/XrDumxDb5WI/AAAAAAAAltw/C_LG8gkIPl86Ek-uxvIoDc_WOawqW2GAgCLcBGAsYHQ/s1600/Bildschirmfoto%2B2020-05-05%2Bum%2B06.41.21.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="350" data-original-width="608" height="230" src="https://1.bp.blogspot.com/-3eHQeW8ExVQ/XrDumxDb5WI/AAAAAAAAltw/C_LG8gkIPl86Ek-uxvIoDc_WOawqW2GAgCLcBGAsYHQ/s400/Bildschirmfoto%2B2020-05-05%2Bum%2B06.41.21.png" width="400" /></a></div><br /><br />What helps when you want to debug your workflow is to save build artifacts. For this I use the third action <i>"actions/upload-artifact"</i> which uploads the log of the PHP server and the Codeception output if the build failed.<br /><br />All other steps in the workflow are based on commands that are executed on the runner (e.g. start MySQL Server, Update Composer, ...).<br /><br />You may note, that the workflow contains 2 "sleep" commands. Both are required so previous commands have enough time to finish execution (start PHP Server and start Selenium).<br /><br />Another thing you may note is, that I added many TYPO3 packages to the <i>require-dev</i> section of my <b>composer.json</b> file. This is not a requirement and can be moved to an additional build step (e.g. <i>composer require typo3/cms-filelist</i> ....).<br /><br /><h3>Acceptance Tests with Codeception</h3><br />In order to execute the Codeception Acceptance Tests, it is required to setup a fully working TYPO3 website including a preconfigured database dump with e.g. pages and records to test. For the Acceptance Tests I included the following files/folders in <i>Tests/Acceptance/_data</i><br /><br /><ul><li><b>config/&nbsp;</b><br />TYPO3 Sites configuration<br /></li><li><b>typo3conf/LocalConfiguration.php</b><br />Preconfigured LocalConfiguration PHP that matches the environment and settings (e.g. DB Credentials) for GitHub Actions<br /></li><li><b>typo3.sql</b><br />Full Database dump of my local test TYPO3 website</li></ul><div><br /></div><div>To separate between Acceptance Test environments (local and GitHub) there are configuration settings for both in&nbsp;<i>Tests/Acceptance/_env</i></div><div><i><br /></i></div><div>At this point I would like to thank&nbsp;<b>Daniel Siepmann</b> for sharing his <a href="https://github.com/DanielSiepmann/workshop-gitlab-acceptance" target="_blank">GitLab CI configuration</a> about Acceptance Tests. I adapted some parts of his examples to my current setup.</div><div><br /></div>Update 29.05.2020: If you want to test an extension against multiple TYPO3 versions, you can use a build matrix as shown in <a href="https://github.com/evoWeb/imagemap/blob/develop/.github/workflows/ci.yml" target="_blank">this</a> example from <b>Sebastian Fischer</b>.<br /><h2 id="tldr">Good to know</h2><div><br /></div><h3>#1 - Composer dependencies are not cached during builds</h3><div><b>Update 15.05.2020:</b> Not required any more, since the issue is <a href="https://github.com/actions/virtual-environments/issues/824">fixed</a>.</div><br />Due to a <a href="https://github.com/actions/virtual-environments/issues/824" target="_blank">misconfiguration</a> in the Ubuntu 18.04 runner (that has already been <a href="https://github.com/actions/virtual-environments/pull/828" target="_blank">fixed</a>), the .composer directory is owned by root:root with 775 rights. This makes it impossible for the runner user to write into that directory. To fix this, make sure to remove the the directory recursive as shown below in a build step before composer is executed.<br /><br /><pre><code><br />- name: Delete .composer directory<br />  run: |<br />    sudo rm -rf ~/.composer<br /></code></pre><br /><br /><h3>#2 - PHP server with "php -S" is obviously not starting</h3><br />I used "php -S 0.0.0.0:8888 -t .Build/public/ &amp;&gt; php.log.txt &amp;" to start a PHP server that serves my application for Acceptance Tests. Somehow the acceptance tests step was not able to connect to the given port and always showed <i>"Failed to connect to x.x.x.x port 8888: Connection refused‚Äù</i><br /><br />To solve this issue, I forced the workflow to stop for 2 seconds (just added "sleep 2;" right after the PHP -S line) so PHP has enough time to server the application.<br /><br /><br /><h3>#3 - MySQL credentials not accepted / MySQL "Connection refused"</h3><div><br />Setting up a build step that uses MySQL I ran into problems connecting to the MySQL server that comes with the default Ubuntu 18.04 runner. The solution to this problem was really simple, since you just have to start the MySQL service.</div><br /><pre><code><br />- name: Start MySQL<br />  run: sudo /etc/init.d/mysql start<br /></code></pre><br />The default credentials for the MySQL are root:root