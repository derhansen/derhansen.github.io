---
layout: post
title: TYPO3 6.2 - Problems with GIFBUILDER and filenames containing umlauts
date: '2015-01-17T07:39:00.001+01:00'
author: Torben Hansen
tags:
- GifBuilder
- UTF8 filesystem
- umlauts
- TYPO3 6.2
modified_time: '2015-01-29T16:39:47.298+01:00'
blogger_id: tag:blogger.com,1999:blog-6517038209122183182.post-2912592419267973251
blogger_orig_url: http://www.derhansen.de/2015/01/typo3-62-problems-with-gifbuilder-and.html
permalink: /2015/01/typo3-62-problems-with-gifbuilder-and.html
---

After migrating a TYPO3 4.5 website to TYPO3 6.2 I had some problems in a third party extension, which resulted in the following exception being thrown.<br /><pre><code><br />#1: PHP Warning: imagecreatefromgif(typo3temp/_processed_/csm_t%C3%A4st.gif): failed to open stream: No such file or directory in /path-to-typo3/typo3_src-6.2.9/typo3/sysext/core/Classes/Imaging/GraphicalFunctions.php line 2873 <br /></code></pre><br />I did some debugging and found out, that the exception was thrown, because the extension used the result of an <b>IMG_RESOURCE </b>object (which in this case is the path to an resized image) for further TypoScript image processing. The special thing about it was, that the exception was only thrown for images where the filename contained <b>umlauts</b>.<br /><br />Generally, I never use umlauts in filenames and if TYPO3 is not configured to use an utf-8 to store filenames, <b>TYPO3 automatically converts</b> umlauts (e.g. "ä" to "ae"). The setup in this TYPO3 installation was different and in the install tool the following settings were present.<br /><pre><code><br />[SYS][UTF8filesystem] = 1<br />[SYS][systemLocale] = de_DE.utf8<br /></code></pre><br />The code in the third party extension was fine for TYPO3 4.5, since resized and temporary images did not include the original filename. For TYPO3 6.2, this is different in some situations and resized/temporary images may get <b>"csm_"</b> as prefix followed by the original filename. This can result in some strange behaviour with images not being rendered as intended. I will demonstrate this below.<br /><br />My test setup uses TYPO3 6.2.9, PHP 5.5 and I have configured [SYS][UTF8filesystem] = 1 and [SYS][systemLocale] = de_DE.utf8.<br /><br />First I uploaded a file named "test.jpg" and assigned it through TypoScript to the frontend output as shown below.<br /><pre><code><br />lib.test = IMAGE<br />lib.test.file = fileadmin/gfx/test.jpg<br /></code></pre><br />There is nothing special about this and as you may expect, the image was successfully rendered in the frontend.<br /><br />Next I uploaded a file names "täst.jpg" and did the same as shown above.<br /><pre><code><br />lib.test = IMAGE<br />lib.test.file = fileadmin/gfx/täst.jpg<br /></code></pre><br />Also here, the image was rendered successfully in the frontend. A look in the sourcecode did show, that the umlaut image filename has been <b>urlencoded</b>.<br /><pre><code><br />&lt;img alt="" border="0" height="250" src="fileadmin/gfx/t%C3%A4st.jpg" width="250" /&gt;<br /></code></pre><br />This all works fine for simple TypoScript IMAGE objects. Now lets get our good, old friend GIFBUILDER into the team :-)<br /><br />The following TypoScript is kept simple for demostration purposes.<br /><pre><code><br />lib.test = IMAGE<br />lib.test {<br />  file = GIFBUILDER<br />  file {<br />    XY = 100,100<br />    10 = IMAGE<br />    10.file = fileadmin/gfx/test.jpg<br />    20 = TEXT<br />    20.text = Test<br />    20.fontColor = #000000<br />    20.fontFile = fileadmin/vera.ttf<br />    20.offset = 10,20<br />  }<br />}<br /></code></pre><br />The output of the TypoScript above is the original image "test.jpg", where the text "Test" is rendered on top of the image.<br /><br />As the last step, I replace the image <b>"test.jpg"</b> with the image <b>"täst.jpg"</b>.<br /><pre><code><br />lib.test = IMAGE<br />lib.test {<br />  file = GIFBUILDER<br />  file {<br />    XY = 100,100<br />    10 = IMAGE<br />    10.file = fileadmin/gfx/täst.jpg<br />    20 = TEXT<br />    20.text = Test<br />    20.fontColor = #000000<br />    20.fontFile = fileadmin/vera.ttf<br />    20.offset = 10,20<br />  }<br />}<br /></code></pre><br />What would you expect to be rendered? I guess, the same result as for the previous example. Actually, the final image is just a GIF file, which has a white background and shows the text "Test". The <b>image</b> with the umlaut is <b>not processed</b>.<br /><br />So why does TYPO3 not render the image, when umlauts are used in the filename? The main reason for this behaviour is located in <b>GIFBUILDER, </b>which uses image path that is rawurlencoded.<br /><br /><b>1.</b> When GIFBUILDER starts to render the final image, it iterates through all TypoScript objects inside it. For IMAGE objects, the GIFBUILDER uses it's own function <b>getResource($file, $fileArray)</b> to return a GIFBUILDER image.<br /><pre><code><br />case 'IMAGE':<br /> $fileInfo = $this-&gt;getResource($conf['file'], $conf['file.']);<br /> if ($fileInfo) {<br />  $this-&gt;combinedFileNames[] = preg_replace('/\\.[[:alnum:]]+$/', '', basename($fileInfo[3]));<br />  $this-&gt;setup[$theKey . '.']['file'] = $fileInfo[3];<br /></code></pre><br /><b>2. </b>The function getResource uses the the function <b>getImgResource</b>&nbsp;from the <b>contentObjectRenderer</b> to create get the (resized/scaled) image resource for the file.<br /><pre><code><br />public function getResource($file, $fileArray) {<br /> if (!GeneralUtility::inList($this-&gt;imageFileExt, $fileArray['ext'])) {<br />  $fileArray['ext'] = $this-&gt;gifExtension;<br /> }<br /> /** @var \TYPO3\CMS\Frontend\ContentObject\ContentObjectRenderer $cObj */<br /> $cObj = GeneralUtility::makeInstance('TYPO3\\CMS\\Frontend\\ContentObject\\ContentObjectRenderer');<br /> $cObj-&gt;start($this-&gt;data);<br /> return $cObj-&gt;getImgResource($file, $fileArray);<br />}<br /></code></pre><br /><b>3. </b>The function getImgResource resizes/scales the given image, saves the processed image as <b>/fileadmin/_processed_/csm_täst_9f3d74f15e.gif</b> and returns an array including a lot of information (see below) about the processed file.<br /><pre><code><br />if ($processedFileObject-&gt;isProcessed() &amp;&amp; !isset($GLOBALS['TSFE']-&gt;tmpl-&gt;fileCache[$hash])) {<br /> $GLOBALS['TSFE']-&gt;tmpl-&gt;fileCache[$hash] = array(<br />  0 =&gt; $processedFileObject-&gt;getProperty('width'),<br />  1 =&gt; $processedFileObject-&gt;getProperty('height'),<br />  2 =&gt; $processedFileObject-&gt;getExtension(),<br />  3 =&gt; $processedFileObject-&gt;getPublicUrl(),<br />  'origFile' =&gt; $fileObject-&gt;getPublicUrl(),<br />  'origFile_mtime' =&gt; $fileObject-&gt;getModificationTime(),<br />  // This is needed by \TYPO3\CMS\Frontend\Imaging\GifBuilder,<br />  // in order for the setup-array to create a unique filename hash.<br />  'originalFile' =&gt; $fileObject,<br />  'processedFile' =&gt; $processedFileObject,<br />  'fileCacheHash' =&gt; $hash<br /> );<br />}<br />$imageResource = $GLOBALS['TSFE']-&gt;tmpl-&gt;fileCache[$hash];<br /></code></pre><br />4. The interesting part here is <b>$processedFileObject-&gt;getPublicUrl()</b>, which returns the public URL for the processed FAL image.<br /><pre><code><br />public function getPublicUrl($identifier) {<br /> $publicUrl = NULL;<br /> if ($this-&gt;baseUri !== NULL) {<br />  $uriParts = explode('/', ltrim($identifier, '/'));<br />  $uriParts = array_map('rawurlencode', $uriParts);<br />  $identifier = implode('/', $uriParts);<br />  $publicUrl = $this-&gt;baseUri . $identifier;<br /> }<br /> return $publicUrl;<br />}<br /></code></pre><br />Array_map is used on all $uriParts with <b>rawurlencode()</b> to ensure the path to the image is encoded correctly. For my testfile "täst.jpg", the function returns "fileadmin/_processed_/csm_t%C3%A4st_9f3d74f15e.gif".<br /><br />Now going back to <b>step 1 </b>where the GIFBUILDER iterates through all TypoScript objects you will see, that $fileInfo[3] is used as a path to the image and this is what results in the GIFBUILDER object not being rendered correctly. As the <b>filename</b> is <b>urlencoded</b>, it can't be used by GIFBUILDER for futher processing which in this case is rendering the text "Test" on it.<br /><br /><b>Conclusion</b><br /><br />The problem only appears under rare curcumstances (using [SYS][UTF8filesystem] = 1), and I believe that not many people are affected of it, since TYPO3 by default has disabled this feature. &nbsp;It seems, this is a bug in TYPO3, which actually was <a href="https://forge.typo3.org/issues/64224" target="_blank">reported</a> by Peter Niederlag<b> nearly at the same time</b> I struggled with the problem. I'll join the discussion and am pretty sure that a bugfix will be available soon.<br /><br /><b>Update 29.01.2015:&nbsp;</b>The bugfix for the problem described above has been merged today for TYPO3 6.2 and current master.