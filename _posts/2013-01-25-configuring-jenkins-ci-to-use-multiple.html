---
layout: post
title: Configuring Jenkins CI to use multiple TYPO3 versions as build target for Extbase
  extensions
date: '2013-01-25T12:53:00.000+01:00'
author: Torben Hansen
tags:
- phpunit
- Extbase
- TYPO3
- Unit Tests
- continuous integration
- Jenkins CI
modified_time: '2013-01-25T12:53:55.597+01:00'
thumbnail: http://3.bp.blogspot.com/-_ywdeCjc5OY/UQEvx_5EYpI/AAAAAAAAEGk/p8yztYlHRS4/s72-c/Jenkins1.jpg
blogger_id: tag:blogger.com,1999:blog-6517038209122183182.post-803336328479388753
blogger_orig_url: http://www.derhansen.de/2013/01/configuring-jenkins-ci-to-use-multiple.html
permalink: /2013/01/configuring-jenkins-ci-to-use-multiple.html
---

<br />If you develop TYPO3 extbase extensions, you should know the concepts of <b>test driven development</b> (TDD). Covering as much as possible of your code with tests ensures, that new code or code changes don't break the functionality of your extension. In bigger projects, where several developers work together on an Extbase extension, it is helpfull to use a&nbsp;continuous integration server to automate testing and to ensure code quality.<br /><br />If the Extbase extension must be compatible with different TYPO3 versions, you have to ensure this during the development process. In this situation, it can be helpful to run automated tests with different TYPO3 versions as build target.<br /><br />In this article, I will show how to configure a single job in Jenkins CI to use <b>multiple TYPO3 versions</b> as a build target for &nbsp;running Extbase extension tests.<br /><br />Before you can start to configure the job in Jenkins CI, you must configure different TYPO3 installations on the server where Jenkins CI is located. This is&nbsp;necessary, because running phpunit tests against an Extbase extension requires the extension to be installed on an working TYPO3 installation.<br /><br /><span style="font-size: large;">Configuring the TYPO3 installations</span><br /><b><br /></b><b>TYPO3 basic setup</b><br />On the Jenkins CI Server, you create 3 new virtual hosts. Each virtual host contains a TYPO3 installation with a different version of TYPO3 (4.5.x, 4.7.x and 6.0.x). To keep the TYPO3 installation maintainable, you can symlink each TYPO3 source to a central place on the server, so you easily can update TYPO3 build versions (e.g. version 4.5.20 to 4.5.21)<br /><br />After the TYPO3 setup, each TYPO3 installation can be opened locally by a hostname like the following<br /><ul><li>http://typo3-45.build.jenkins.local/</li><li>http://typo3-47.build.jenkins.local/</li><li>http://typo3-60.build.jenkins.local/</li></ul><div><b>Setting permissions</b><br />Next you have to login to each TYPO3 installation and update some settings in the install tool.</div><div><br /></div><div>Set the file mode mask to:<br />[BE][fileCreateMask] = 0666&nbsp;</div><div>[BE][folderCreateMask] = 0777</div><div><br /></div><div>This is necessary for TYPO3 6.0, because there seems to be some problems with local permissions in typo3temp/ (<i>Uncaught TYPO3 Exception: #1294586098: Lock file could not be created</i>) when running the tests through Jenkins CI.&nbsp;</div><div><br /></div><div><b>Installing and configuring the TYPO3 extension "phpunit"</b></div><div>In order to run automated tests in a TYPO3 installation, you have to install the extension "phpunit" from TER. Be sure to get a compatible version of phpunit for each TYPO3 version you use.&nbsp;</div><div><br /></div><div>After the extension "phpunit" has been installed, you must create a backend user named "_cli_phpunit". Just create the user and set a random password.&nbsp;</div><div><br /></div><div>Make sure, that you can at least execute the tests which came with "phpunit" successfully. This step only ensures, that tests actually can be run successfully.</div><div><br /></div><div><span style="font-size: large;">Setting up the job in Jenkins</span></div><div><br /></div><div>The next step is to configure the job in Jenkins. First of all, we create an empty job in Jenkins.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-_ywdeCjc5OY/UQEvx_5EYpI/AAAAAAAAEGk/p8yztYlHRS4/s1600/Jenkins1.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="72" src="http://3.bp.blogspot.com/-_ywdeCjc5OY/UQEvx_5EYpI/AAAAAAAAEGk/p8yztYlHRS4/s400/Jenkins1.jpg" width="400" /></a></div><br /><br />The next step is to create an ANT Build File (built.xml), which contains all settings for &nbsp;the job. Below is an example ANT Build File for the job described in this article.<br /><pre><code><br />&lt;project name="TYPO3-Extbase-Extension" default="build" basedir="."&gt;<br />        &lt;property name="output" location="${basedir}/build/"/&gt;<br />        &lt;property file="build.properties" /&gt;<br /><br />        &lt;target name="init"&gt;<br />                &lt;mkdir dir="${output}"/&gt;<br />                &lt;mkdir dir="${output}/phpcs/"/&gt;<br />        &lt;/target&gt;<br /><br />        &lt;target name="build" depends="init, typo3-45-unittests, typo3-47-unittests, typo3-60-unittests, phpcs, phpmd, phpcpd"&gt;<br />        &lt;/target&gt;<br /><br />        &lt;target name="typo3-45-unittests"&gt;<br />                &lt;exec executable="php" failonerror="true"&gt;<br />                        &lt;arg path="${typo3path-45}/typo3/cli_dispatch.phpsh" /&gt;<br />                        &lt;arg value="phpunit" /&gt;<br />                        &lt;arg path="${basedir}/src/Tests" /&gt;<br />                &lt;/exec&gt;<br />        &lt;/target&gt;<br /><br />        &lt;target name="typo3-47-unittests"&gt;<br />                &lt;exec executable="php" failonerror="true"&gt;<br />                        &lt;arg path="${typo3path-47}/typo3/cli_dispatch.phpsh" /&gt;<br />                        &lt;arg value="phpunit" /&gt;<br />                        &lt;arg path="${basedir}/src/Tests" /&gt;<br />                &lt;/exec&gt;<br />        &lt;/target&gt;<br /><br />        &lt;target name="typo3-60-unittests"&gt;<br />                &lt;exec executable="php" failonerror="true"&gt;<br />                        &lt;arg path="${typo3path-60}/typo3/cli_dispatch.phpsh" /&gt;<br />                        &lt;arg value="phpunit" /&gt;<br />                        &lt;arg path="${basedir}/src/Tests" /&gt;<br />                &lt;/exec&gt;<br />        &lt;/target&gt;<br /><br />        &lt;target name="phpcs"&gt;<br />                &lt;exec executable="phpcs"&gt;<br />                        &lt;arg line="--report=checkstyle<br />                                --report-file=${output}/phpcs/checkstyle.xml<br />                                --standard=/var/lib/jenkins/external_libraries/PHP_CodeSniffer/TYPO3/ruleset.xml<br />                                ${basedir}" /&gt;<br />                &lt;/exec&gt;<br />        &lt;/target&gt;<br /><br />        &lt;target name="phpmd"&gt;<br />                &lt;exec executable="phpmd"&gt;<br />                        &lt;arg line=" . xml codesize,unusedcode,naming,design --reportfile ${output}/messdetector.xml --exclude Tests/" /&gt;<br />                &lt;/exec&gt;<br />        &lt;/target&gt;<br /><br />        &lt;target name="phpcpd"&gt;<br />                &lt;exec executable="phpcpd"&gt;<br />                        &lt;arg line=" --log-pmd ${output}/phpcpd.xml ." /&gt;<br />                &lt;/exec&gt;<br />        &lt;/target&gt;<br />&lt;/project&gt;<br /></code></pre><br /></div><div>The ANT Build File also requires a configuration file (built.properties) with some properties.<br /><pre><code><br />php=/usr/bin/php5<br />typo3path-45=/var/www/path-to-your-typo3-45-root<br />typo3path-47=/var/www/path-to-your-typo3-47-root<br />typo3path-60=/var/www/path-to-your-typo3-60-root<br /></code></pre><br /></div><div>After both files have been created, copy them to the /workspace directory of your job. At his point, the workspace directory should not exist and you have to create it manually. Make sure you set the <b>correct permissions</b>, so the jenkins user has read-write permissions to that directory.</div><div><br />The next thing you have to do is to configure the repository, where Jenkins CI checks out the TYPO3 Extbase extension. In this article, the Extbase extension is located in a GIT Repository. Configure the <b>Repository URL</b>, the <b>Branch</b> and set the "<b>Local subdirectory for repo (optional)</b>" to "src". Below is a screenshot of the settings.<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-lSuE-5IAtIw/UQEwqT3FGAI/AAAAAAAAEHk/E8Xt7jLnNPM/s1600/Jenkins2.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="400" src="http://3.bp.blogspot.com/-lSuE-5IAtIw/UQEwqT3FGAI/AAAAAAAAEHk/E8Xt7jLnNPM/s400/Jenkins2.jpg" width="388" /></a></div><br /><br />Now you have to configure the ANT Build File. Just insert the path to the Build File as shown below.<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-VGh14vCmqWI/UQJDNbc-AcI/AAAAAAAAEH0/U0NLoT1YIKc/s1600/jenkins3.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="153" src="http://3.bp.blogspot.com/-VGh14vCmqWI/UQJDNbc-AcI/AAAAAAAAEH0/U0NLoT1YIKc/s400/jenkins3.jpg" width="400" /></a></div><br /><br />The ANT Build File above also contains some settings for phpcs, phpmd and phpcpd. If you want to use Checkstyle, PHP messdetection and PHP duplicate code detection, you can configure those settings in the Post-Build Actions as shown on the screenshot below.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-RZUWOHP4oAw/UQEwBmMMCxI/AAAAAAAAEHE/CvCJaIn92kk/s1600/jenkins4.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="400" src="http://2.bp.blogspot.com/-RZUWOHP4oAw/UQEwBmMMCxI/AAAAAAAAEHE/CvCJaIn92kk/s400/jenkins4.jpg" width="395" /></a></div><br /><br />Now your job is ready to run the first time. Actually <i>it will fail</i>, since the configuration process is not finished yet, but it is required to run the job, so the Extbase extension is checked out from the GIT repository.<br /><br /><span style="font-size: large;">Installing the Extbase extension and running the job</span><br /><br />After running the job the first time, you should have the folder /src inside the jobs workspace directory. This folder contains the extension, which we now <b>symlink </b>to the /typo3conf/ext directory of each TYPO3 installation we created earlier. Make sure, that the <b>name of the symlink</b> is identical to the <b>extension key</b>.<br /><br />The symlink ensures, that updates to the extension automatically are available in all TYPO3 installations.<br /><br />Now you have to login to each TYPO3 installation and install the Extbase extension with the extension manager.<br /><br />When the Extbase extension is installed, you are ready to run the job and will (hopefully) see, that your Extbase extension´s tests will run on all configured TYPO3 versions.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-3kr-3OxP8W4/UQEwBsDP3OI/AAAAAAAAEHA/x_Fj-4_EeKI/s1600/jenkins5.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="373" src="http://1.bp.blogspot.com/-3kr-3OxP8W4/UQEwBsDP3OI/AAAAAAAAEHA/x_Fj-4_EeKI/s400/jenkins5.jpg" width="400" /></a></div><br /><br />You can also configure the job only to use a special TYPO3 version as build target as shown below.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-EDfKKBnYEjc/UQEwBmc7B0I/AAAAAAAAEHI/OrW0D4tIbrU/s1600/jenkins6.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="98" src="http://3.bp.blogspot.com/-EDfKKBnYEjc/UQEwBmc7B0I/AAAAAAAAEHI/OrW0D4tIbrU/s400/jenkins6.jpg" width="400" /></a></div>The above example will only run tests against TYPO3 version 4.5.<br /><br /><span style="font-size: large;">Additional notes</span><br /><br />During the development process of an extension, the table-structure may change due to new or changed fields. Those changes are not automatically updated in the local TYPO3 installations, where the extension is installed, so you have to make sure, that you update the extension´s table structure by using the extension manager in each TYPO3 installation, if you made changes to the extension´s table structure.<br /><br /><br /></div><br />