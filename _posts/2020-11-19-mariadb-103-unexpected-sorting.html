---
layout: post
title: Unexpected sorting behavior after update from MariaDB 10.1 to 10.3
date: '2020-11-19T20:08:00.002+01:00'
author: Torben Hansen
tags:
- '10.1'
- order by
- mariadb
- '10.3'
modified_time: '2020-11-23T08:09:11.004+01:00'
blogger_id: tag:blogger.com,1999:blog-6517038209122183182.post-1966801751255806775
blogger_orig_url: http://www.derhansen.de/2020/11/mariadb-103-unexpected-sorting.html
permalink: /2020/11/mariadb-103-unexpected-sorting.html
---

<p><b>TL;DR</b> The sorting behavior changed from MariaDB 10.1 to 10.2 due to a <a href="https://jira.mariadb.org/browse/MDEV-11320">bug</a> in MariaDB 10.1&nbsp;</p><p>After updating from Ubuntu 18.04 LTS to 20.4 LTS a previously working a PHP application which contains a data export suddenly did not return the expected result any more. I debugged this scenario by comparing the database query results in the data export and obviously, something in the sorting changed from MariaDB 10.1 to MariaDB 10.3</p><p>In order to fully reproduce the problem, I created a really simple use case as shown in the SQL dump below.</p><pre><code><br />CREATE TABLE `test` (<br />  `a` int(11) NOT NULL AUTO_INCREMENT,<br />  `b` varchar(255) NOT NULL,<br />  `c` text NOT NULL,<br />  `d` varchar(255) NOT NULL,<br />  PRIMARY KEY (`a`)<br />) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8;<br /><br />INSERT INTO `test` VALUES (1,'A','\r\n','CRLF'),(2,'A','',''),(3,'A','',''),(4,'A','\r\n','CRLF'),(5,'A','','');<br /></code></pre><p>So we have a really simple table structure with some data. The only special thing is, that 2 values in column "c" contain a carriage return and line feed (CRLF). Since this is not printed when selecting data, I also added column d which contains the value "CRLF" for rows, where column c is a CRLF.</p><p>So now I select some data.&nbsp;<br /></p><pre><b>SELECT * FROM test;</b><br /><br /><br />+---+---+----+------+<br />| a | b | c  | d    |<br />+---+---+----+------+<br />| 1 | A |    | CRLF |<br />| 2 | A |    |      |<br />| 3 | A |    |      |<br />| 4 | A |    | CRLF |<br />| 5 | A |    |      |<br />+---+---+----+------+<br /></pre><p>This result is as I would expect it. Now sorting comes into the game...</p><h3 style="text-align: left;"><span style="font-weight: normal;">Ubuntu 18.04 with MariaDB&nbsp;10.1.47</span></h3> <pre><b>SELECT * FROM test ORDER BY b ASC, c ASC, a ASC;</b><br /><br /><br />+---+---+----+------+<br />| a | b | c  | d    |<br />+---+---+----+------+<br />| 2 | A |    |      |<br />| 3 | A |    |      |<br />| 5 | A |    |      |<br />| 1 | A |    | CRLF |<br />| 4 | A |    | CRLF |<br />+---+---+----+------+<br /></pre><p>OK, so the sorting of column c puts the CRLF values at the end for MariaDB 10.1. Now I try the same on another system.</p><h3 style="text-align: left;"><span style="font-weight: normal;">Ubuntu 20.04 with MariaDB 10.3.25</span></h3><pre><b>SELECT * FROM test ORDER BY b ASC, c ASC, a ASC;</b><br /><br /><br />+---+---+----+------+<br />| a | b | c  | d    |<br />+---+---+----+------+<br />| 1 | A |    | CRLF |<br />| 4 | A |    | CRLF |<br />| 2 | A |    |      |<br />| 3 | A |    |      |<br />| 5 | A |    |      |<br />+---+---+----+------+<br /></pre> <p>As you notice, the sorting for column c is now reversed...</p><p>I did not find a setting in MariaDB 10.3 to switch back to the sorting as it was in MariaDB 10.1. I could also reproduce the same behavior on MySQL 8.0. So... bug or feature - who knows? I think the described scenario can be considered as an edge case, but if you somehow depend on, that sorting for a column with CRLF values is exactly the same, this can hit you really hard.</p><p>I created an <a href="https://jira.mariadb.org/browse/MDEV-24250">issue</a> in the MariaDB bug tracker. I'm&nbsp;curious if this is supposed behavior or not.</p><p><b>Update 23.11.2020:</b> It has been confirmed, that the sorting behavior is as expected in MariaDB 10.2+ and that it was wrong in 10.1</p><p><br /></p>