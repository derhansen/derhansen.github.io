---
layout: post
title: Security considerations when working with TYPO3 Formhandler extension
date: '2014-09-10T14:24:00.000+02:00'
author: Torben Hansen
tags:
- security
- formhandler
- TYPO3
- PreProcessor_LoadDB
- Finisher_DB
modified_time: '2014-09-10T14:35:03.087+02:00'
blogger_id: tag:blogger.com,1999:blog-6517038209122183182.post-8672784978870210929
blogger_orig_url: http://www.derhansen.de/2014/09/security-considerations-typo3-formhandler.html
permalink: /2014/09/security-considerations-typo3-formhandler.html
---

<div><u>First of all:</u> This article&nbsp;<b>does not show&nbsp;any existing security problems with formhandler</b>. It shows you two&nbsp;<b>real world examples</b>, which I found on a TYPO3 website I did not create, but had to do maintenence for. I will also show what I have done, to (hopefully) resolve the problems.</div><div><br /></div>The TYPO3 extension <b>formhandler </b>is known as the swiss army knife, when it comes to all kind of forms in TYPO3. Formhandler is <b>flexible </b>in many ways and allows a TYPO3 integrator not just to create complex forms with several validation options, but also to <b>prefill fields</b> when a form is loaded or to <b>save/update fields</b> in the TYPO3 database when a form is successfully submitted. I really like this extension and use it in many projects because of it's clean structure, flexibility and because it is actively maintained.<br /><br />Formhandler is often not just used to create simple contact forms, but also to provide forms which <b>shows, creates or modifies records</b> from/in the TYPO3 database. If the TYPO3 integrator does not think about <b>security </b>at this point, there are several things that can go wrong.<br /><br />I'm not really a security expert, so if I write totally nonsence in this article, feel free contact me, so the article will contain correct and helpfull information for others.<br /><div><br /></div><b>Example 1 - PreProcessor_LoadDB and GP variable causing leackage of sensitive data</b><br /><b><br /></b>In the first example, a website user does submit data through a form from a <b>third party extension</b>. After the data is submitted, the user receives an e-mail containing a <b>link to a formhandler page</b>, where the user has to fill out some other form fields. The link, which is sent to the user is like shown below:<br /><br />http://www.domain.tld/myform.html?formname[uid]=123<br /><br />The parameter "<b>formname[uid]</b>" contains the uid of the newly created record from the third party extension.<br /><br />When I opened the form the first time, I did not see anything special (expect from the URL parameter). All form fields where empty, so I asked myself, why the URL contained the parameter. After I had a look at the output of the website, I knew, what the URL was used for. The output of the website contained 3 hidden formfields like shown below:<br /><pre><code><br />&lt;input type="hidden" name="formname[uid]" value="123"&gt;<br />&lt;input type="hidden" name="formname[recipientname]" value="John Doe"&gt;<br />&lt;input type="hidden" name="formname[email]" value="email@domain.tld"&gt;<br /></code></pre><br />Ouch, now I could easily find out, who else did submit data through the form from the third party extension by just <b>increasing/decreasing the uid</b>. The original TYPO3 integrator used a&nbsp;<b>PreProcessor_LoadDB preprocessor </b>to load the additional data in the hidden fields.<br /><br />Depending on how the database lookup is integrated, it could result in a SQL injection, if you just pass the given UID directly to the <b>select.where</b> of the&nbsp;<b>PreProcessor_LoadDB preprocessor</b>.<br /><br /><b>Example 2 -&nbsp;Finisher_DB and GP variable causing unwanted data manipulation</b><br /><br />The second example uses the same form as shown in example 1. When a website user fills out the form, all fields get submitted to the server and an e-mail ist sent with a <b>Finisher_Mail</b> finisher. As you may guess, the recipient email is taken from the hidden input field, which in case is very bad, since you just can replace the e-mail address in the hidden field with another e-mail address and after form submission, a totally <i>different recipient </i>will receive an e-mail sent from the server.<br /><br />If you don't think it can get worst, it actually will. The formhandler setup did also contain a <b>Finisher_DB</b> finisher, which <b>updated some fields</b> on a given record in the TYPO3 database. Since the <b>uid </b>to this record is parsed directly through <b>GET/POST</b> variables, it can just be changed and within that, you can just submit the form with different uids and <b>update</b> the fields that the Finisher_DB updates with garbage - of course for <b>all records</b> in the table.<br /><br /><b>Problem summary and solution approach</b><br /><br />All named problems rely on the some cause - user input is just seen as trusted. At no point it is actually checked, if the user has changed the uid or has replaced the values from hidden input fields with own content.<br /><br />Actually, to take benefit from&nbsp;<b>PreProcessor_LoadDB </b>to prefill fields with Database values<b>&nbsp;</b>or<b>&nbsp;</b><b>Finisher_DB</b>&nbsp;to update records, you actually <b>need to know the uid</b> from the record where to fetch/update the desired values. So how can you make sure, that the uid is <b>not changed by the user</b>?<br /><br /><b>Adding a HMAC to the URL</b><br /><br />We can add a second parameter to the URL, that contains the <b>HMAC </b>for the <b>uid </b>parameter. This HMAC will later on be used to <b>validate</b>, if the <b>uid </b>has been modified by the user.<br /><br />TYPO3 has a <b>HashService </b>(TYPO3\CMS\Extbase\Security\Cryptography\HashService), which can be used to <b>generate </b>and <b>validate </b>HMACs. To generate a HMAC for a given string, the TYPO3 HashService uses the TYPO3 <b>encryption key</b> as shared secret. The function&nbsp;generateHmac($string) returns a HMAC for a given string as shown below (short version without type/encryption key check)<br /><pre><code><br />hash_hmac('sha1', $string, $encryptionKey);<br /></code></pre><br />The TYPO3 HashService also has a function called validateHmac($string, $hmac) to validate, if the given string matches a given HMAC.<br /><br />Using the generateHmac function, I end up with formhandler URLs like shown below:<br /><br />http://www.domain.tld/myform.html?formname[uid]=123&amp;formname[uidhmac]=averylonghmac<br /><br /><b>Adding HMAC check to formhandler</b><br /><br />Formhandler has <b>interceptors</b>, which can be used on <b>init </b>and on <b>save </b>of a form. Init-interceptors are called each time a form is displayed and save-interceptors are called before the form-finishers are executed. So the best approach to add the <b>HMAC check</b> is to do this through an own <b>interceptor</b>.<br /><br />I created a configurable interceptor, which is able to use the validation functions from the TYPO3 HashService.<br /><br />The source code for the new interceptor is available in this <a href="https://gist.github.com/derhansen/0ba55250f063e1ab69eb" target="_blank">gist</a>. You can just create an own extension with this class and then use it in the formhandler TypoScript settings. Below follows an example TypoScript setup, which uses the new interceptor.<br /><pre><code><br />initInterceptors.1 {<br />  class = Tx_MyFormhandlerExtension_Interceptor_HashService<br />  config {<br />    redirectPage = 11<br />    validateHmac {<br />      fields.uid = uidhmac<br />    }<br />  }<br />}  <br /></code></pre><br />The configuration above now validates, if the <b>given uidhmac</b> is the correct HMAC for the <b>given uid</b>. If this validation fails, the user is redirected to a configured page.<br /><br />You can also use the interceptor with <b>appended HMAC string</b>. Those HMACs are created using the&nbsp;appendHmac function in the HashService. Basically it just takes the given string and appends the HMAC for the string to it. An url could look like shown below.<br /><br />http://www.domain.tld/myform.html?formname[appendedhmac]=123averylonghmac<br /><br />To validate the given appended HMAC string you can use the interceptor as shown below.<br /><br /><pre><code>initInterceptors.1 {<br />  class = Tx_MyFormhandlerExtension_Interceptor_HashService<br />  config {<br />    redirectPage = 11<br />    validateAndStripHmac {<br />      fields.1 = appendedhmac<br />    }<br />  }<br />}  <br /></code></pre><div><b><br /></b><b>Conclusion</b><br /><br />Nearly all described problems from the two examples have been solved with the new interceptor. A user can now not just increase/decrease the GET/POST parameter uid to retreive the personal data of other users and he/she can may also not be able to update other database records, if the interceptor is also configured as a <b>save-interceptor</b>.<br /><br />The only problem that remains is, that a user can replace the fetched e-mail-address with different one. I simply resolved this issue by removing the e-mail-address from the output and doing a lookup for it in a special save-interceptor I created.<br /><br />I've created a <a href="https://forge.typo3.org/issues/61281" target="_blank">patch</a> for formhandler and maybe the new interceptor can make it as a core feature of formhandler.<br /><br /><b>So always remember:</b> Don't trust user input and always think twice when working with user generated data.<br /><br /></div>