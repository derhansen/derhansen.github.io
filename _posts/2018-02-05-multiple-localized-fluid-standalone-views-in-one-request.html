---
layout: post
title: TYPO3 - How to render a Fluid standalone view multiple times in different languages
date: '2018-02-05T14:12:00.000+01:00'
author: Torben Hansen
tags:
- fluid standalone view
- TYPO3
- localization
modified_time: '2018-02-05T14:12:25.310+01:00'
blogger_id: tag:blogger.com,1999:blog-6517038209122183182.post-8087346133079574866
blogger_orig_url: http://www.derhansen.de/2018/02/multiple-localized-fluid-standalone-views-in-one-request.html
permalink: /2018/02/multiple-localized-fluid-standalone-views-in-one-request.html
---

Back in 2015, I wrote 2 blogposts (<a href="https://www.derhansen.de/2015/10/fluid-standaloneview-translation-scheduler-task.html" target="_blank">first</a> and <a href="https://www.derhansen.de/2015/11/typo3-using-fluid-standaloneview-to.html" target="_blank">second</a>) about rendering a localized Fluid standalone view in a scheduler task (commandController). The main problem was to render a&nbsp;<b>Fluid standalone view</b>&nbsp;multiple times within the <b>same request</b> but with <b>different languages</b>. Back then, my solution was to create an own ViewHelper and a modified version of the TYPO3 LocalizationUtility which were responsible for handling the localization changes during the rendering request.<br /><br />Meanwhile, I got feedback from readers of my blog pointing me to a <b>more simple solution</b> for the problem.<br /><br />The main problem with changing the TYPO3 backend language during one request is the <b>language cache</b>, which is only initialized once for the current language. So when you switch the backend language multiple times, the <i>cached language files</i> for the previous language will still be used.<br /><br />The solution is to <b>unset the language cache</b> for the extension you are rendering your Fluid standalone view from. In order to do so, you have to extend the TYPO3 LocalizationUtility with a new function as shown below.<br /><br /><pre><code><br />class LocalizationUtility extends \TYPO3\CMS\Extbase\Utility\LocalizationUtility<br />{<br />    /**<br />     * Resets the language cache for the given extension key<br />     *<br />     * @param string $extensionName<br />     */<br />    public static function resetLocalizationCache($extensionName)<br />    {<br />        unset(static::$LOCAL_LANG[$extensionName]);<br />    }<br />}<br /></code><br /></pre>The example code below shows, how to use the <i>resetLocalizationCache</i> method before rendering a Fluid standalone view in a given language.<br /><br /><pre><code><br />/**<br /> * Renders a Fluid StandaloneView respecting the given language<br /> *<br /> * @param string $language The language (e.g. de, dk or se)<br /> * @return string<br /> */<br />public function renderStandaloneView($language = '')<br />{<br />    // Set the extensionKey<br />    $extensionKey = GeneralUtility::underscoredToUpperCamelCase('standaloneview');<br /><br />    if ($language !== '') {<br />        // Temporary set Language of current BE user to given language<br />        $GLOBALS['BE_USER']-&gt;uc['lang'] = $language;<br />        LocalizationUtility::resetLocalizationCache($extensionKey);<br />    }<br /><br />    /** @var \TYPO3\CMS\Fluid\View\StandaloneView $view */<br />    $view = $this-&gt;objectManager-&gt;get(StandaloneView::class);<br />    $view-&gt;setFormat('html');<br />    $template = GeneralUtility::getFileAbsFileName(<br />        'EXT:standaloneview/Resources/Private/Templates/StandaloneView.html'<br />    );<br />    $view-&gt;setTemplatePathAndFilename($template);<br /><br />    // Set Extension name, so localizations for extension get respected<br />    $view-&gt;getRequest()-&gt;setControllerExtensionName($extensionKey);<br /><br />    return $view-&gt;render();<br />}<br /></code><br /></pre>So with a small extension of the LocalizationUtility it is now easily possible to render a Fluid standalone view in a language of choice and it is also possible to switch the language within the same request (e.g. sending out localized e-mails to multiple recipients).<br /><br />I updated the <a href="https://github.com/derhansen/standaloneview" target="_blank">Demo-Extension</a>, which contains a backend module and a command controller for demonstration purposes.<br /><br />I would like to thank&nbsp;<b>Johannes Rebhan</b> for giving me the hint about the localization cache and also<b>&nbsp;Ulrich Fischer </b>for showing me a <a href="https://gist.github.com/derhansen/1eee357e472be595692bf655a28a1557" target="_blank">different approach</a>, which requires more code, but lead to the same result.<br /><br /><br />