---
layout: post
title: TYPO3 - PHPUnit Testing Framework tests for repositories with storagePids
date: '2013-10-22T07:44:00.000+02:00'
author: Torben Hansen
tags:
- setStoragePageIds
- phpunit
- Extbase
- TYPO3
- storagePid
- Testing Framework
modified_time: '2013-10-22T07:44:24.966+02:00'
blogger_id: tag:blogger.com,1999:blog-6517038209122183182.post-7577723319752307351
blogger_orig_url: http://www.derhansen.de/2013/10/typo3-phpunit-testing-framework-tests.html
permalink: /2013/10/typo3-phpunit-testing-framework-tests.html
---

When I develop a TYPO3 ExtBase extension, I often use the <b>Testing Framework</b> shipped with the TYPO3 extension <b>PHPUnit</b>. With the Testing Framework it is possible to create real <b>testrecords in the TYPO3 database</b> and use those records in your tests to verify everything works as expected.<br /><br />In a project I faced the situation, that one of my repository methods did not find the records created with the Testing Framework. Well, after some hours of debugging I finally found the solution.<br /><br /><div><div><b>The problem</b></div><div><br />I created a new TYPO3 ExtBase extension with some tables, a controller and a view. Really nothing special about that. I then created a function in my repository which searches for some records in the database with a configurable limit.&nbsp;</div></div><pre><code><br /><br />/**<br /> * Returns the latest records. <br /> *<br /> * @param int $limit The Limit<br /> * @return array|\TYPO3\CMS\Extbase\Persistence\QueryResultInterface<br /> */<br />public function findLatest($limit) {<br /> $query = $this-&gt;createQuery();<br /> $query-&gt;setOrderings(array('datecreated' =&gt; QueryInterface::ORDER_DESCENDING));<br /> $query-&gt;setLimit((integer)$limit);<br /> $records = $query-&gt;execute();<br /> return $records;<br />}<br /></code></pre><br />Then I started to create some tests for the newly created function in the repository. One test was as following.<br /><br /><pre><code><br />/**<br /> * Test if findLatest returns expected amout of records if limit given<br /> *<br /> * @test<br /> * @return void<br /> */<br />public function findLatestReturnsLimitedResult() {<br /> $this-&gt;testingFramework-&gt;createRecord('tx_myext_domain_model_table', array('datecreated' =&gt; time()));<br /> $this-&gt;testingFramework-&gt;createRecord('tx_myext_domain_model_table', array('datecreated' =&gt; time()));<br /> $this-&gt;testingFramework-&gt;createRecord('tx_myext_domain_model_table', array('datecreated' =&gt; time()));<br /><br /> $this-&gt;createTestRecords();<br /> $this-&gt;assertEquals(2, $this-&gt;myRepository-&gt;findLatest(2)-&gt;count());<br />}<br /></code></pre><br />In the test above, 3 records with the Testing Framework are created and I'll use the function findLatest with a given limit of 2 to test, if really 2 records are returned.<br /><br />Well, actually findLatest did <b>return 0 records</b>. I then created some real records in the TYPO3 backend and verified, that findLatest actually works as expected, so the problem must be somewhere in my test or in the TYPO3 setup.<br /><br />So I started to debug my test and first of all, I verified, that the Testing Framework really created 3 records. Yes, 3 records were created, all having the <b>pid 0</b>. Ok then, since the testrecords where created correctly, there seem to be something wrong with the search. I'll then debugged the <b><a href="http://www.derhansen.de/2013/01/typo3-get-resulting-sql-from-extbase.html" target="_blank">resulting SQL Query</a></b> from the repository function findLatest and found out, that the records were searched in <b>pid 1</b>. OK, so the problem seems to have something to do with the storagePids.<br /><br /><b>ExtBase, tests and storagePid(s)</b><br /><br />When you create an ExtBase extension, the Extension Builder automatically creates some TS for you where you can set the storagePid(s) for your extension.<br /><br /><pre><code><br />persistence {<br />  # cat=plugin.tx_myext//a; type=string; label=Default storage PID<br />  storagePid =<br />}<br /></code></pre><br />This <b>storagePid </b>can be used to set the<b> location of your records</b> in the TYPO3 backend. Generally every TYPO3 Extension you create with the Extension Builder makes use of the storagePid(s) and overrides them, if a startingPoint is set in the plugin.<br /><br />When you run your tests in TYPO3 backend (or through your IDE), ExtBase uses the <b>backendConfigurationManager</b> to get the ExtBase framework configuration. In the backendConfigurationManager class, there is a function called <b>getDefaultStoragePid()</b>, which returns the local function getCurrentPageId(). Let's have a look at this function.<br /><pre><code><br />protected function getCurrentPageId() {<br /> $pageId = (integer) \TYPO3\CMS\Core\Utility\GeneralUtility::_GP('id');<br /> if ($pageId &gt; 0) {<br />  return $pageId;<br /> }<br /> // get current site root<br /> $rootPages = $GLOBALS['TYPO3_DB']-&gt;exec_SELECTgetRows('uid', 'pages', 'deleted=0 AND hidden=0 AND is_siteroot=1', '', '', '1');<br /> if (count($rootPages) &gt; 0) {<br />  return $rootPages[0]['uid'];<br /> }<br /> // get root template<br /> $rootTemplates = $GLOBALS['TYPO3_DB']-&gt;exec_SELECTgetRows('pid', 'sys_template', 'deleted=0 AND hidden=0 AND root=1', '', '', '1');<br /> if (count($rootTemplates) &gt; 0) {<br />  return $rootTemplates[0]['pid'];<br /> }<br /> // fallback<br /> return self::DEFAULT_BACKEND_STORAGE_PID;<br />}<br /></code></pre><br />So, if your TYPO3 installation where you develop your ExtBase extension has a <b>root page</b>, then this page ID is returned. Or if you have no root page but a <b>TS Template</b> which is marked as<b> root template</b>, then the page ID of that page is returned.<br /><br />The returned page ID is used in the <b>queryFactory</b> class to set the <b>storagePid(s)</b>, which leads to the situation I described earlier.<br /><br /><b>Solution / Workarounds</b><br /><br />So how do we tell TYPO3 to search for our test records in <b>pid 0 </b>during tests? On solution is to set the storagePid for the ExtBase Framework to 0 like shown below.<br /><pre><code><br />config.tx_extbase {<br />  persistence {<br />    storagePid = 0<br />  }<br />}<br /></code></pre><br />This solution has some <b>problems</b>, since it can be <b>overridden </b>by other extensions and also it requires <b>manual configuration</b> when setting up your testing environment.<br /><br />You could also just <b>disable</b> the check for <b>storagePid(s)&nbsp;</b>(with setRespectStoragePage(FALSE)) in your tests, but I think this solution is'nt really good, since your tests then also may find records you created in the TYPO3 backend during development.<br /><br />If you want to keep your tests independent, I would recommend to<b> set the storagePid(s)</b> directly in the <b>setup </b>of the tests.<br /><pre><code><br />/**<br /> * Set up for test<br /> *<br /> * @return void<br /> */<br />public function setUp() {<br /> $this-&gt;testingFramework = new \Tx_Phpunit_Framework('tx_myext');<br /> $this-&gt;fixture = $this-&gt;objectManager-&gt;get('Derhansen\\MyExt\\Domain\\Repository\\MyRepository');<br /><br /> /** @var $querySettings Typo3QuerySettings */<br /> $querySettings = $this-&gt;objectManager-&gt;get('TYPO3\\CMS\\Extbase\\Persistence\\Generic\\Typo3QuerySettings');<br /> $querySettings-&gt;setStoragePageIds(array(0));<br /> $this-&gt;fixture-&gt;setDefaultQuerySettings($querySettings);<br />}<br /></code></pre><br />The code above sets the <b>storage pid to 0</b> and now the tests should find the records created with the testing framework and tests should not interfere with other records created manually.