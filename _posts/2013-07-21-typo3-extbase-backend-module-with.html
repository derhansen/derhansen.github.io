---
layout: post
title: TYPO3 ExtBase backend module with progressbar using AJAX
date: '2013-07-21T19:44:00.000+02:00'
author: Torben Hansen
tags:
- progressbar
- Backend module
- AJAX
- JQuery UI
- Extbase
- JQuery
modified_time: '2013-07-21T19:50:51.164+02:00'
thumbnail: http://3.bp.blogspot.com/-vtyh8Ei1ViI/Uewa5kAbulI/AAAAAAAAGCM/vlXbBU6o5GQ/s72-c/extbase-bemodule.png
blogger_id: tag:blogger.com,1999:blog-6517038209122183182.post-3641107446468740985
blogger_orig_url: http://www.derhansen.de/2013/07/typo3-extbase-backend-module-with.html
permalink: /2013/07/typo3-extbase-backend-module-with.html
---

<br />Assume you have created a TYPO3 ExtBase Extension and must enable the user to <b>import data</b> (e.g. CSV file) to the tables of your TYPO3 ExtBase extension. With ExtBase, you can easily create a <b>TYPO3 backend module</b> so the user can <b>upload</b> the CSV file and start the <b>data import</b>.<br /><br />Now assume the user uploads a <b>very big set of data (several 100 MBs)</b> to be imported and starts the data import process. Well, the user will see the <b>hourglass a long, long time</b> and if the user is impacient, he will surely assume that something went wrong and will click somewhere else in the TYPO3 backend and within that cancel the data import.<br /><br />So would'nt it be nice if you could show the user a <b>progressbar</b> or an <b>updating informal text</b>, that the import is still running?<br /><br />When you look at the concepts of some extensions with backend modules in TER, you will often see, that PHP methods like <b>flush()</b> or <b>ob_flush()</b> is used to update data in a backend module for long taking processes.<br /><br />With ExtBase you can't use flush(), since the output for the backend module is rendered with fluid and the output will first display, when the action that displays the content has finished.<br /><br />In this article I will show how to use <b>AJAX</b> in a <b>TYPO3 ExtBase backend module</b> to show an updating <b>JQuery UI progressbar</b>.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-vtyh8Ei1ViI/Uewa5kAbulI/AAAAAAAAGCM/vlXbBU6o5GQ/s1600/extbase-bemodule.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="180" src="http://3.bp.blogspot.com/-vtyh8Ei1ViI/Uewa5kAbulI/AAAAAAAAGCM/vlXbBU6o5GQ/s400/extbase-bemodule.png" width="400" /></a></div><br /><br />Please note, that the <a href="https://github.com/derhansen/extbase_bemodule_ajax" target="_blank">example code located on Github</a> has been created with <b>TYPO3 6.1</b> and uses namespaces, so it only runs with TYPO3 &gt; 6.x. But - the shown technique can also be adapted to TYPO3 4.5.<br /><br />First of all, I've created a TYPO3 extension with the extension builder. The extension has a backend module called "mod1". This module uses the controller "Example" and the action "index".<br /><div><pre><code><br />/**<br /> * Registers a Backend Module<br /> */<br />\TYPO3\CMS\Extbase\Utility\ExtensionUtility::registerModule(<br /> 'derhansen.' . $_EXTKEY,<br /> 'web', // Make module a submodule of 'web'<br /> 'mod1', // Submodule key<br /> '', // Position<br /> array(<br />  'Example' =&gt; 'index',<br />  <br /> ),<br /> array(<br />  'access' =&gt; 'user,group',<br />  'icon'   =&gt; 'EXT:' . $_EXTKEY . '/ext_icon.gif',<br />  'labels' =&gt; 'LLL:EXT:' . $_EXTKEY . '/Resources/Private/Language/locallang_mod1.xlf',<br /> )<br />);<br /></code></pre><br /></div><div>The extension builder automatically creates Typoscript files with constants and setup settings for the backend module templates. Those settings look like:<br /><br /><pre><code><br />templateRootPath = EXT:extbase_bemodule_ajax/Resources/Private/Backend/Templates/<br /></code></pre><br /></div>As you may notice, the <b>templates, layouts and partials</b> are located in a subfolder named "Backend". Using this, you always need to <i>include the extension's Typoscript </i>in your sites Typoscript template. If you remove the folder "Backend" and just place your templates, layouts and partials in the "normal" folder-structure of an ExtBase extension, there is no need to include the Typoscript of your extension. I have done this to keep things simple.<br /><br />Next I've created the layout and the template for the backend module. Notice, that I have created a <b>viewhelper</b> named&nbsp;IncludeJQueryViewHelper, which automatically includes JQuery and JQueryUi with the nesceccary CSS files to the backend module.<br /><br /><pre><code><br />{namespace h=derhansen\ExtbaseBemoduleAjax\ViewHelpers\Be}<br /><br />&lt;h:IncludeJQuery jquery="1" jqueryui="1" /&gt;<br /><br />&lt;f:be.container loadExtJs="0" loadPrototype="0" loadScriptaculous="0"&gt;<br />...<br />&lt;/f:be.container&gt;<br /></code></pre><br />Also notice, that the f:be.container viewhelper is configured to disable extJs, prototype and scriptaculous.<br /><br />In the template for the backend module I have placed some text, a JQuery UI Progressbar and a JQuery UI Button. I also created some Javascript code, which starts starts the progressbar and also retrieves the status of the progressbar by AJAX.<br /><br />When the start-button is clicked, an <b>AJAX request (startLongProcess)</b> is called which starts a long taking process in our ExampleController. The AJAX request is <b>asynchronous</b>, so the process is not blocking the TYPO3 backend. Right after the long taking process is started, another <b>AJAX request (checkLongProcess)</b> is called which retrieves the status of the long taking process and updates the progressbar.<br /><br />To keep things simple, the long taking action in the ExampleController just executes a for-loop 20 times and does a sleep(1) on each iteration. Below follows both the startLongProcess action, which starts the long process and the checkLongProcess action, which is used to update the progressbar.<br /><br /><pre><code><br />/**<br /> * Example for a long process (just loops 20 seconds). Returns TRUE if process is finished<br /> *<br /> * @return bool TRUE if process is finished<br /> */<br />public function startLongProcessAction() {<br /> for ( $i = 1; $i &lt;= 20; $i++) {<br />  /* Increase counter stored in session variable */<br />  session_start();<br />  $_SESSION['progval'] = $i * 5;<br />  session_write_close ();<br />  sleep(1);<br /> }<br /><br /> /* Reset the counter in session variable to 0 */<br /> session_start();<br /> $_SESSION['progval'] = 0;<br /> session_write_close ();<br /> return json_encode(TRUE);<br />}<br /><br />/**<br /> * Checks the status of the long process<br /> *<br /> * @return int Status of process in percent<br /> */<br />public function checkLongProcessAction() {<br /> session_start();<br /> if (!isset($_SESSION['progval'])) {<br />  $_SESSION['progval'] = 0;<br /> }<br /> session_write_close ();<br /> return json_encode($_SESSION['progval']);<br />}<br /></code></pre><br />Notice, that this example uses <b>PHP session variables</b> to store the actual state of the long taking process. You can also use a database or other techniques to store the actual state.<br /><br />When working with PHP session variables inside a method, you have to keep in mind, that the session variable is stored, after the method is finished to prevent concurrent writes to the session. To store the session variable while the for-loop is running, you have to use&nbsp;session_write_close() to actually store the session variable.<br /><br />Finally I updated ext_tables.php so the 2 new actions can be called by the module.<br /><br /><b>Conclusion</b><br />Creating a ExtBase backend module that uses AJAX to dynamically update content on the modules page is quite simple. You can use the same techniques for backend modules as for TYPO3 frontend plugins.<br /><br />The complete code for the example shown here is available on <a href="https://github.com/derhansen/extbase_bemodule_ajax" target="_blank">Github</a><br /><br />