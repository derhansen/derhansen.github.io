---
layout: post
title: Standalone unit- and functional tests for ExtBase extensions in TYPO3 6.2
date: '2014-06-27T14:00:00.000+02:00'
author: Torben Hansen
tags:
- TYPO3 6.2 unit tests
- TYPO3 CMS
- TYPO3 Travic CI
- TYPO3 6.2 functional tests
modified_time: '2015-06-03T09:08:01.151+02:00'
thumbnail: http://4.bp.blogspot.com/-ixrwIm5tkcY/U6wdveg89WI/AAAAAAAAJaU/qOuQpQ5zIbo/s72-c/phpstorm-unittests.png
blogger_id: tag:blogger.com,1999:blog-6517038209122183182.post-2824459237302284428
blogger_orig_url: http://www.derhansen.de/2014/06/standalone-unit-and-functional-tests.html
permalink: /2014/06/standalone-unit-and-functional-tests.html
---

The TYPO3 core team did a lot of <a href="http://wiki.typo3.org/Blueprints/StandaloneUnitTests" target="_blank">work</a> in the last weeks to simplify unit- and functional testing in TYPO3, so now everything about testing TYPO3 core and TYPO3 extensions has become much more clear and straightlined. In this article I will describe how I switched the unit- and functional tests in one of my TYPO3 extensions from <b>cli_dispatch</b> to <b>standalone phpunit tests</b>.<br /><br /><b>Initial situation</b><br /><br />I am working an an <a href="https://github.com/derhansen/sf_event_mgt" target="_blank">event management and registration extension</a> for TYPO3. Since I always work with unit- and functional tests and a CI environment, I've setup my IDE PHPStorm to execute unit- and functional tests as described in my <a href="http://www.derhansen.de/2012/12/typo3-cms-run-extbase-unit-tests-in.html" target="_blank">old blogpost</a>&nbsp;and I also integrated the extension in <b><a href="https://travis-ci.org/" target="_blank">Travis CI</a></b> and <b><a href="https://scrutinizer-ci.com/" target="_blank">Scrutinizer CI</a></b>. Since the extension only should be compatible with TYPO3 6.2+, I already used the new <a href="http://wiki.typo3.org/Functional_testing" target="_blank">functional tests</a> introduced in TYPO3 6.2 instead of the functional testing framework which comes with the TYPO3 extension phpunit.<br /><br /><b>Standalone unit tests for PHPStorm</b><br /><br />Helmut Hummel wrote an <a href="http://typo3.helmut-hummel.de/post/63972451370/executing-typo3-cms-unit-test-tests-in-phpstorm" target="_blank">excellent article</a> about how to execute TYPO3 Unit tests in PHPStorm. I've setup my unit tests as descibed in Helmut's article, but with one difference. Instead of configuring the unit test bootstrap file as described in step 5, I created a PHPUnit configuration file, which holds all PHPUnit configuration and which later on also will be used on Travis CI for test execution.<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://4.bp.blogspot.com/-ixrwIm5tkcY/U6wdveg89WI/AAAAAAAAJaU/qOuQpQ5zIbo/s1600/phpstorm-unittests.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="220" src="http://4.bp.blogspot.com/-ixrwIm5tkcY/U6wdveg89WI/AAAAAAAAJaU/qOuQpQ5zIbo/s1600/phpstorm-unittests.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Unit tests use an alternative configuration file</td></tr></tbody></table>The configuration file for PHPUnit is like shown below.<br /><br /><pre><code>&lt;phpunit<br />        backupGlobals="false"<br />        backupStaticAttributes="false"<br />        bootstrap="../../../../../typo3/sysext/core/Build/UnitTestsBootstrap.php"<br />        colors="true"<br />        convertErrorsToExceptions="true"<br />        convertWarningsToExceptions="true"<br />        forceCoversAnnotation="false"<br />        processIsolation="false"<br />        stopOnError="false"<br />        stopOnFailure="false"<br />        stopOnIncomplete="false"<br />        stopOnSkipped="false"<br />        verbose="false"&gt;<br /><br />    &lt;testsuites&gt;<br />        &lt;testsuite name="EXT:sf_event mgt"&gt;<br />            &lt;directory&gt;../Unit/&lt;/directory&gt;<br />        &lt;/testsuite&gt;<br />    &lt;/testsuites&gt;<br />&lt;/phpunit&gt;<br /></code></pre><br />After I had setup everything, I executed my unit tests, which actually <i>did not run</i>. With my old setup and within the TYPO3 extension PHPUnit, the tests executed successfully. After some hours of debugging, I fixed the failing tests. I had to do <b>more mocking</b> inside my tests, so they really could run independent from a working TYPO3 installation.<br /><br /><b>Standalone functional tests for PHPStorm</b><br /><b><br /></b>The configuration for functional tests in PHPStorm is similar to the unit test setup with some small differences. You must switch on <b>PHPUnit process isolation</b> and you must <b>configure database settings</b>, if you do not run the tests in an working TYPO3 CMS installation. Documentation about functional tests in TYPO3 can be found in the TYPO3 wiki about <a href="http://wiki.typo3.org/Functional_testing" target="_blank">functional testing</a>.<br /><br />Since I want to run the functional tests without a working TYPO3 CMS installation and also on Travis CI, I configured a PHPUnit configuration file and added <b>environment variables</b> for database access to the PHPStorm Run/Debug configuration.<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://3.bp.blogspot.com/-89EcBrPpSN4/U6wigFxuj5I/AAAAAAAAJag/UciF74xpqks/s1600/phpstorm-functionaltests.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="237" src="http://3.bp.blogspot.com/-89EcBrPpSN4/U6wigFxuj5I/AAAAAAAAJag/UciF74xpqks/s1600/phpstorm-functionaltests.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Environment variables for functional tests</td></tr></tbody></table>The PHPUnit configuration file is like shown below:<br /><pre><code><br />&lt;phpunit<br />        backupGlobals="false"<br />        backupStaticAttributes="false"<br />        bootstrap="../../../../../typo3/sysext/core/Build/FunctionalTestsBootstrap.php"<br />        colors="true"<br />        convertErrorsToExceptions="true"<br />        convertWarningsToExceptions="true"<br />        forceCoversAnnotation="false"<br />        processIsolation="true"<br />        stopOnError="false"<br />        stopOnFailure="false"<br />        stopOnIncomplete="false"<br />        stopOnSkipped="false"<br />        verbose="false"&gt;<br /><br />    &lt;testsuites&gt;<br />        &lt;testsuite name="EXT:sf_event mgt"&gt;<br />            &lt;directory&gt;../Functional/&lt;/directory&gt;<br />        &lt;/testsuite&gt;<br />    &lt;/testsuites&gt;<br />&lt;/phpunit&gt;<br /></code></pre><br />Note, that I've set <b>processIsolation </b>to <b>true</b>.<br /><br />After I had setup the functional test configuration, my functional tests also did not work. Again this was caused <b>incomplete mocking</b> and also by direct usage of the <b>ExtBase objectManager</b> in my tests. After I completed the mocking and removed all&nbsp;direct usages of the objectmanager in the tests, the functional tests were executed successfully in PHPStorm.<br /><br /><b>Unit and functional tests on Travis CI and code analysis on Scrutinizer CI</b><br /><b><br /></b>My TYPO3 extension was already integrated in <b>Travis CI</b> and <b>Scrutinizer CI</b>. Since I switched from test execution through cli_dispatch to standalone unit test execution, I had to modify my Travis CI configuration to execute tests directly through phpunit.<br /><br />Both unit- and functional tests can be executed on commandline with the following commands:<br /><pre><code><br />phpunit -c typo3conf/ext/sf_event_mgt/Build/UnitTests.xml<br />phpunit -c typo3conf/ext/sf_event_mgt/Build/FunctionalTests.xml<br /></code></pre><br />Please note, that the test execution as shown above only works if the commands are executed from within a directory with a full <b>TYPO3 CMS directory structure</b>. In case of the functional tests, you must also set environment variables for Database access.<br /><br />To get the test execution working on Jenkins CI, you just have to clone the TYPO3 core and create the TYPO3 directory structure (fileadmin, uploads and typo3conf/ext) and finally move your extension to typo3conf/ext/. After that, you're ready to execute both unit- and functional tests on Jenkins CI.<br /><br />My final .travis.yml file is like shown below:<br /><pre><code><br />language: php<br />php:<br />  - 5.3<br />  - 5.4<br /><br />env:<br />  - DB=mysql TYPO3_BRANCH=master COVERAGE=0<br /><br />matrix:<br />  include:<br />    - php: 5.5<br />      env: DB=mysql TYPO3_BRANCH=master COVERAGE=1<br /><br />notifications:<br />  email:<br />    - derhansen@gmail.com<br /><br />before_script:<br />  - cd ..<br />  - git clone --single-branch --branch $TYPO3_BRANCH --depth 1 https://github.com/TYPO3/TYPO3.CMS.git typo3_core<br />  - mv typo3_core/* .<br />  - sudo apt-get install parallel<br />  - composer self-update<br />  - composer install<br />  - mkdir -p uploads typo3temp typo3conf/ext<br />  - mv sf_event_mgt typo3conf/ext/<br /><br />script:<br />  - &gt;<br />    if [[ "$COVERAGE" == "0" ]]; then<br />      echo;<br />      echo "Running unit tests";<br />      ./bin/phpunit --colors -c typo3conf/ext/sf_event_mgt/Tests/Build/UnitTests.xml<br />    fi<br />  - &gt;<br />    if [[ "$COVERAGE" == "1" ]]; then<br />      echo;<br />      echo "Running unit tests";<br />      ./bin/phpunit --coverage-clover=coverage.clover --colors -c typo3conf/ext/sf_event_mgt/Tests/Build/UnitTests.xml<br />    fi<br />  - &gt;<br />    if [[ "$COVERAGE" == "1" ]]; then<br />      echo;<br />      export typo3DatabaseName="typo3";<br />      export typo3DatabaseHost="localhost";<br />      export typo3DatabaseUsername="root";<br />      export typo3DatabasePassword="";<br />      find . -wholename '*/typo3conf/ext/sf_event_mgt/Tests/Functional/*Test.php' | parallel --gnu 'echo; echo "Running functional test suite {}"; ./bin/phpunit --colors -c typo3conf/ext/sf_event_mgt/Tests/Build/FunctionalTests.xml {}'<br />    fi<br />  - &gt;<br />    if [[ "$COVERAGE" == "1" ]]; then<br />      echo;<br />      echo "Uploading code coverage results";<br />      wget https://scrutinizer-ci.com/ocular.phar<br />      cp -R typo3conf/ext/sf_event_mgt/.git .<br />      php ocular.phar code-coverage:upload --format=php-clover coverage.clover<br />    fi<br /></code></pre><br />In order to get functional tests to execute successfully, you must provide <b>TYPO3 database credentials</b> and the <b>TYPO3 database name </b>as shown in the config above.<br /><br />The Travis CI configuration file already includes <b>code coverage analysis</b> through <a href="https://scrutinizer-ci.com/" target="_blank">Scrutinizer CI</a>. In the last part of the configuration, the code coverage results are uploaded to Scrutinizer.<br /><br /><b>Merging unit- and functional test code coverage data</b><br /><b><br /></b>[EDIT 28.06.2014] It seems I have missed one thing regarding <b>code coverage</b>. With cli_dispatch test execution, both unit- and functional tests run at the same time resulting in <b>one file with code coverage data </b>(if code coverage is switched on). With standalone unit- and functional tests, tests are seperated in <i>at least 2 runs</i>. The config for Travis CI I posted above just handles <i>code coverage for unit tests</i> and not for funtional tests. Also, the Travis CI config runs functional tests in parallel to speed up functional test execution. To include code coverage data from both unit- and functional tests, I changed to Travis CI config as following for the functional test execution.<br /><pre><code><br />find . -wholename '*/typo3conf/ext/sf_event_mgt/Tests/Functional/*Test.php' | parallel --gnu 'echo; echo "Running functional test suite {}"; ./bin/phpunit --coverage-clover={}functionaltest-coverage.clover --colors -c typo3conf/ext/sf_event_mgt/Tests/Build/FunctionalTests.xml {}'<br /></code></pre><br />With this change, phpunit creates <b>one file with code coverage data</b> for each f<b>unctional test suite</b>. Keep in mind, that this will <b>really slow down</b> functional test execution.<br /><br />And for the upload of code coverage data to Scrutinizer CI I changed the following: <br /><pre><code><br />find . -wholename '*/typo3conf/ext/sf_event_mgt/Tests/Functional/*Test.php' -exec php ocular.phar code-coverage:upload --format=php-clover {}functionaltest-coverage.clover \;<br /></code></pre><br />This uploads each file with code coverage data for functional tests to scrutinizer CI. The Scrutinizer CI configuration must now be changed as shown below.<br /><pre><code><br />external_code_coverage:<br />    timeout: 700<br />    runs: 3<br /></code></pre><br />With this change, Scrutinizer CI waits for 3 code coverage data uploads and merges them, so finally the code analysis end up with code coverage data from all unit- and functional test. There is one <b>downside</b> with this settings. The <b>number of runs</b> must be changed <b>manually</b> depending on the <b>amount of test suites with code coverage data</b> you have in your project. But finally, Scrutinizer CI shows the same code coverage as PHPStorm.<b><br /></b><br /><br /><div class="separator" style="clear: both; text-align: center;"></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://1.bp.blogspot.com/-9mUEOTdrX9k/U66tf7fSs5I/AAAAAAAAJb8/atcuxnfmAVw/s1600/code-coverage-phpstorm.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="116" src="http://1.bp.blogspot.com/-9mUEOTdrX9k/U66tf7fSs5I/AAAAAAAAJb8/atcuxnfmAVw/s1600/code-coverage-phpstorm.png" width="200" /></a></td><td></td><td style="text-align: center;"><a href="http://1.bp.blogspot.com/-8Cl4iP9Zuo4/U66tf35l1WI/AAAAAAAAJcA/VPiNkbD-NTc/s1600/Code-Coverage-Scrutinizer.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="192" src="http://1.bp.blogspot.com/-8Cl4iP9Zuo4/U66tf35l1WI/AAAAAAAAJcA/VPiNkbD-NTc/s1600/Code-Coverage-Scrutinizer.png" width="200" /></a></td></tr><tr><td class="tr-caption" colspan="3" style="text-align: center;">Code coverage in PHPStorm and Scrutinizer CI both show 92%</td></tr></tbody></table><br /><div class="separator" style="clear: both; text-align: center;"></div><b>Conclusion</b><br /><br />The switch from cli_dispatch to standalone test execution for ExtBase extensions is'nt really complicated. Test setup for unit- and functional tests has become much more <b>easy and clear</b> now and I think (and hope) that standalone unit- and functional tests will reduce the barriers for TYPO3 extension developers to actually create TYPO3 Extension with good test coverage.<br /><br />I would like to thank all people in the TYPO3 community who made standalone tests possible. I really appreciate the work that has been done.