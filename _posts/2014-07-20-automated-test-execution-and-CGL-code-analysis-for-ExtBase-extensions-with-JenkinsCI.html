---
layout: post
title: TYPO3 6.2 - automated test execution and CGL code analysis for ExtBase extensions
  with Jenkins CI
date: '2014-07-20T14:34:00.001+02:00'
author: Torben Hansen
tags:
- Extbase
- Unit Tests
- TYPO3 6.2
- ANT
- Jenkins CI
modified_time: '2015-01-02T12:34:08.456+01:00'
thumbnail: http://3.bp.blogspot.com/-dzrH_5_pDfk/U8powhPamxI/AAAAAAAAJg0/vj_vb7JOow0/s72-c/job-setup-jobname.png
blogger_id: tag:blogger.com,1999:blog-6517038209122183182.post-3615714917015781779
blogger_orig_url: http://www.derhansen.de/2014/07/automated-test-execution-and-CGL-code-analysis-for-ExtBase-extensions-with-JenkinsCI.html
permalink: /2014/07/automated-test-execution-and-CGL-code-analysis-for-ExtBase-extensions-with-JenkinsCI.html
---

Some of my public repositories on <a href="https://github.com/" target="_blank">GitHub</a> are integrated in <a href="https://travis-ci.org/" target="_blank">Travis CI</a> and <a href="https://scrutinizer-ci.com/" target="_blank">Scrutinizer CI</a>, so each new commit automatically starts a predefined build process where <b>tests</b> and <b>code analysis</b> are executed. For open source projects, the combination of GitHub, Travis CI and Scrutinizer CI is perfect. For <b>private&nbsp;repositories</b>,&nbsp;you can also use those services if you pay for them or you could built up the <b>CI environtment</b> yourself.<br /><br />On work I've been using Jenkins CI for some years now to build our PHP, Java and Android projects. I'm also using Jenkins CI to process tests automation and code analysis for our TYPO3 extensions, which should be tested on different TYPO3 versions. This configuration was some kind of complicated, since each TYPO3 extension had to be installed in a <b>working TYPO3 environment</b> before it could be tested automatically by Jenkins CI. I've written a <a href="http://www.derhansen.de/2013/01/configuring-jenkins-ci-to-use-multiple.html" target="_blank">blogpost</a> about this setup back in january 2013.<br /><br />In this article I describe how I've setup a simple job in Jenkins CI for a <b>TYPO3 6.2 ExtBase extension</b>. The job executes the s<b>tandalone unit tests</b> and also does some <b>TYPO3 CGL code analysis</b>. Everything shown below should be seen <b>as an example</b>, since some analysis tasks like code coverage or pdepend are missing.<br /><br /><b>Prerequisites</b><br /><ul><li>A running Jenkins CI server with at least the Git Plugin and the PHP Plugin</li><li>ANT, composer, phpunit, phpmd and phpcs installed on the Jenkins CI server</li><li>Jenkins workspace dir configured with&nbsp;${ITEM_ROOTDIR}/workspace/</li><li>The TYPO3 CMS CGL installed as a global standard</li><li>An ExtBase extension with some working unit tests</li></ul><div><b>Creating the ANT build file</b></div><div><br /></div><div>As fas as I know it is still best to use <b>ANT</b> for PHP projects on Jenkins CI. Therefore I created an <b>ANT build file</b>, which contains some tasks for the build. The ANT build file is added to my ExtBase extension (e.g.&nbsp;my_extkey/Resources/Private/Build/build.xml).</div><div><br /></div><div>The first task will just create some directories.</div><pre><code><br />&lt;target name="init"&gt;<br />   &lt;mkdir dir="${env.WORKSPACE}/build"/&gt;<br />   &lt;mkdir dir="${env.WORKSPACE}/build/phpcs"/&gt;<br />   &lt;mkdir dir="${env.WORKSPACE}/build/phpunit"/&gt;<br />   &lt;mkdir dir="${env.WORKSPACE}/typo3_core"/&gt;<br />&lt;/target&gt;<br /></code></pre><div><br /></div><div>The final structure of the <b>workspace</b> should look like shown below.<br /><ul><li>build/ - contains build results&nbsp;</li><li>jobname/ - the name of the Jenkins CI job. In this example the <b>TYPO3 extension key</b></li><li>typo3_core/ - path for the TYPO3 core</li></ul><div>The next task I've created is the task for the <b>unit tests execution</b>. I'll clone the current TYPO3 6.2 master branch, install all dependencies with composer, create typo3conf, typo3temp and uploads folder, symlink the extbase extension to typo3conf/ext/ and finally execute the unit tests.</div><pre><code><br />&lt;target name="unittests"&gt;<br />    &lt;exec executable="git" failonerror="true"&gt;<br />        &lt;arg line="clone --single-branch --branch master --depth 1 https://github.com/TYPO3/TYPO3.CMS.git ${env.WORKSPACE}/typo3_core" /&gt;<br />    &lt;/exec&gt;<br /><br />    &lt;exec executable="composer"&gt;<br />        &lt;arg line="install --working-dir ${env.WORKSPACE}/typo3_core" /&gt;<br />    &lt;/exec&gt;<br /><br />    &lt;mkdir dir="${env.WORKSPACE}/typo3_core/uploads"/&gt;<br />    &lt;mkdir dir="${env.WORKSPACE}/typo3_core/typo3temp"/&gt;<br />    &lt;mkdir dir="${env.WORKSPACE}/typo3_core/typo3conf/ext"/&gt;<br /><br />    &lt;symlink link="${env.WORKSPACE}/typo3_core/typo3conf/ext/${env.JOB_NAME}" resource="${env.WORKSPACE}/${env.JOB_NAME}"/&gt;<br /><br />    &lt;exec executable="phpunit" dir="${env.WORKSPACE}/typo3_core"&gt;<br />        &lt;arg line="--log-junit ${env.WORKSPACE}/build/phpunit/unittests.xml  --bootstrap typo3/sysext/core/Build/UnitTestsBootstrap.php typo3conf/ext/${env.JOB_NAME}/Tests/Unit" /&gt;<br />    &lt;/exec&gt;<br />&lt;/target&gt;<br /></code></pre><div><br /></div><div>Note that I'll set the task to <b>fail on error</b> if the TYPO3 core could not be cloned.&nbsp;</div></div><div><br />Finally I'll add some code analysis tasks and a cleanup task to remove some files from the build.<br /><pre><code><br />&lt;target name="phpcs"&gt;<br />    &lt;exec executable="phpcs"&gt;<br />        &lt;arg line="--report=checkstyle --report-file=${env.WORKSPACE}/build/phpcs/checkstyle.xml --standard=TYPO3CMS --extensions=php,inc ${env.WORKSPACE}/${env.JOB_NAME}" /&gt;<br />    &lt;/exec&gt;<br />&lt;/target&gt;<br /><br />&lt;target name="phpmd"&gt;<br />    &lt;exec executable="phpmd"&gt;<br />        &lt;arg line=" ${env.WORKSPACE}/${env.JOB_NAME} xml codesize,unusedcode,naming,design --reportfile ${env.WORKSPACE}/build/messdetector.xml --exclude Tests/" /&gt;<br />    &lt;/exec&gt;<br />&lt;/target&gt;<br /><br />&lt;target name="phpcpd"&gt;<br />    &lt;exec executable="phpcpd"&gt;<br />        &lt;arg line=" --log-pmd ${env.WORKSPACE}/build/phpcpd.xml ${env.WORKSPACE}/${env.JOB_NAME}" /&gt;<br />    &lt;/exec&gt;<br />&lt;/target&gt;<br /><br />&lt;target name="cleanup"&gt;<br />    &lt;delete dir="${env.WORKSPACE}/typo3_core"/&gt;<br />&lt;/target&gt;<br /></code></pre><br /></div>The complete ANT build file can be found <a href="https://gist.github.com/derhansen/7f13e431dc0d6413099a" target="_blank">here</a>. It should be generic so it can be used with a common ExtBase extension without any further modifications.<br /><br /><u>Update 02.01.2015</u><br /><br />I updated the ANT build file so it also supports the execution of functional tests.<br /><br /><b>Jenkins CI job setup</b><br /><br />The job setup on Jenkins CI is as shown on the next screenshots.<br /><br />The ANT script assumes, that the&nbsp;<b>job name&nbsp;</b>is equal to the&nbsp;<b>TYPO3 extension key</b>. So I'll setup the job in Jenkins CI as shown above.<br /><div><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://3.bp.blogspot.com/-dzrH_5_pDfk/U8powhPamxI/AAAAAAAAJg0/vj_vb7JOow0/s1600/job-setup-jobname.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="http://3.bp.blogspot.com/-dzrH_5_pDfk/U8powhPamxI/AAAAAAAAJg0/vj_vb7JOow0/s1600/job-setup-jobname.png" height="150" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">The job name must be TYPO3 extension key</td></tr></tbody></table>In the SCM settings you have to make sure, that the source code is cloned to a&nbsp;<b>seperate directory</b>&nbsp;named like the extension key.<br /><div><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://2.bp.blogspot.com/-BjfB-CwB5ng/U8pouxLtn6I/AAAAAAAAJhM/UfKmySxQtzo/s1600/job-git-settings.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="http://2.bp.blogspot.com/-BjfB-CwB5ng/U8pouxLtn6I/AAAAAAAAJhM/UfKmySxQtzo/s1600/job-git-settings.png" height="166" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">The ExtBase extension should be cloned in a seperate directory</td></tr></tbody></table>Next I'll set the path to the ANT build.xml file.<br /><div><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://4.bp.blogspot.com/-WpKNyEklMfM/U8pou34GEOI/AAAAAAAAJgg/k07HSSlJ30A/s1600/job-ant-settings.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="http://4.bp.blogspot.com/-WpKNyEklMfM/U8pou34GEOI/AAAAAAAAJgg/k07HSSlJ30A/s1600/job-ant-settings.png" height="80" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">ANT configuration</td></tr></tbody></table>After the build, the code analysis should be processed.<br /><div><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://2.bp.blogspot.com/-gI73umzJ0sY/U8pouz0vG9I/AAAAAAAAJhE/CzFezV2j3wo/s1600/job-postbuild-analysis.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="http://2.bp.blogspot.com/-gI73umzJ0sY/U8pouz0vG9I/AAAAAAAAJhE/CzFezV2j3wo/s1600/job-postbuild-analysis.png" height="192" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Post build analysis</td></tr></tbody></table><br /><div style="-webkit-text-stroke-width: 0px; color: black; font-family: 'Times New Roman'; font-size: medium; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;"></div><br /><div style="-webkit-text-stroke-width: 0px; color: black; font-family: 'Times New Roman'; font-size: medium; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; margin: 0px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;">And finally the results of the&nbsp;<b>phpunit test</b>s should be evaluated.</div><div style="-webkit-text-stroke-width: 0px; color: black; font-family: 'Times New Roman'; font-size: medium; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; margin: 0px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;"><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://1.bp.blogspot.com/-GSj7VDdDUWA/U8povsU4KsI/AAAAAAAAJhA/jumJPlxnlC8/s1600/job-postbuild-phpunit.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="http://1.bp.blogspot.com/-GSj7VDdDUWA/U8povsU4KsI/AAAAAAAAJhA/jumJPlxnlC8/s1600/job-postbuild-phpunit.png" height="190" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">PHPUnit result analysis</td></tr></tbody></table><br />I've configured the build just to be <b>instable</b>, if a <b>unit test fails</b> (set threshold to zero). You can also configure the build to fail, if a certain amount of failed/incomplete tests are reached.<br /><br />After some builds, you'll end up with a Jenkins CI job, that shows some graphs of the code analysis.<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://2.bp.blogspot.com/-6_-lMc67oFI/U8pow8KWyHI/AAAAAAAAJg8/_qtOeR-tOGY/s1600/test-results.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="http://2.bp.blogspot.com/-6_-lMc67oFI/U8pow8KWyHI/AAAAAAAAJg8/_qtOeR-tOGY/s1600/test-results.png" height="320" width="164" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Code analysis graph</td></tr></tbody></table>If the build contains <b>failing tests</b>, then the build status will become "instable" and the build will show, which tests failed.<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://2.bp.blogspot.com/-7ce-joXgktU/U8povxhgm3I/AAAAAAAAJg4/S5eul7-gDDo/s1600/job-result-failed.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="http://2.bp.blogspot.com/-7ce-joXgktU/U8povxhgm3I/AAAAAAAAJg4/S5eul7-gDDo/s1600/job-result-failed.png" height="283" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Build with one failed test</td></tr></tbody></table><b><br /></b><b>Outlook and conclusion</b><br /><br />As written before, the Jenkins CI job I've shown above should be seen as an <b>simple example</b>. I did not add any <b>build triggers</b> and executed the jobs manually. In a production CI environment this task should be automated, so each new commit to the repository will trigger the build.<br /><br />Also I did not add any <b>functional tests</b> to the TYPO3 ExtBase extension, because this would require MySQL <b>database access</b> and would make the ANT script and the job setup more complicated. Cloning the whole TYPO3 master branch each time the job executes could also be done more simple, if you have a clone of the repository locally somewhere and just copy all files from there.<br /><br />Depending on you requirements, you could also add <b>Selenium tests</b>&nbsp;(follow <a href="http://www.derhansen.de/2013/03/setting-up-jenkins-ci-selenium-grid-and.html" target="_blank">this article</a> on how to setup a Selenium Grid on Jenkins CI) to the job or you could take another step forward and completely automate the deployment of the ExtBase Extension.<br /><br />Anyhow, I hope I could give you a little insight in using <b>Jenkins CI</b> to automate some tasks a TYPO3 developer should take care of.<br /><br />By the way: When I wrote this article, I did a <b>clean installation</b> of Jenkins CI in my home network and configured everything <b>from scratch</b> to see, if the example shown in this article works as expected. This all just took me about 1-2 hours until I had a working CI environment.<br /><br />